<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HSE Capital & Estates Cash Flow v2.93</title>
  
  <link rel="icon" href="https://assets.hse.ie/static/hse-frontend/assets/favicons/favicon.ico">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Chart.js & Plugins -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
  
  <!-- PDF Generation Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
    
    body { 
      font-family: 'Inter', system-ui, -apple-system, sans-serif; 
      -webkit-font-smoothing: antialiased;
      background-color: #f8fafc;
    }
    
    /* HSE Brand Colours */
    :root {
      --hse-primary: #006858; /* HSE Green */
      --hse-secondary: #00bfa5;
    }

    /* Custom Scrollbar */
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: transparent; }
    .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    
    /* Range Slider Styling */
    input[type=range] { -webkit-appearance: none; background: transparent; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
      background: var(--hse-primary); margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); cursor: grab;
    }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px;
    }

    /* Toggle Switch Fixed Animation */
    .toggle-checkbox {
      left: 0;
      transition: transform 0.3s ease, border-color 0.3s ease;
    }
    .toggle-checkbox:checked {
      transform: translateX(1.25rem); /* Slides 20px right */
      border-color: #006858;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #006858;
    }

    /* --- PDF & PRINT MODE OPTIMISATIONS v2.93 (LANDSCAPE) --- */
    
    /* The "Ghost" Copy - Optimised for A4 LANDSCAPE */
    .pdf-mode {
      width: 1050px !important; /* A4 Landscape width (approx) */
      background: white !important;
      padding: 15px !important;
      font-family: 'Inter', sans-serif !important;
    }
    
    /* Hide unwanted elements */
    .pdf-mode .print-hidden { display: none !important; }
    .pdf-mode .print-visible { display: block !important; }
    
    /* Top Cards: 4 in a row for Landscape */
    .pdf-mode .pdf-top-cards { 
        display: grid !important; 
        grid-template-columns: 1fr 1fr 1fr 1fr !important; /* 4 columns */
        gap: 10px !important; 
        margin-bottom: 15px !important;
    }

    /* Bottom Section: FLEX LAYOUT (Strict Side-by-Side) */
    .pdf-mode .pdf-bottom-section {
        display: flex !important;
        flex-direction: row !important;
        align-items: flex-start !important;
        justify-content: space-between !important;
        gap: 15px !important;
        margin-top: 0 !important;
    }

    /* Left Side: Chart */
    .pdf-mode .pdf-chart-container {
        width: 60% !important;
        margin-bottom: 0 !important;
        border: 1px solid #e2e8f0 !important;
        padding: 10px !important;
        border-radius: 8px !important;
    }
    
    /* Right Side: Data Tables Wrapper */
    .pdf-mode .pdf-sidebar-data {
        width: 38% !important;
        display: block !important; 
        border: 1px solid #e2e8f0 !important;
        border-radius: 8px !important;
        padding: 8px !important;
        background: #f8fafc !important;
        height: auto !important;
    }

    /* Split the Data Sidebar into 2 Columns (Actuals | Planned) */
    .pdf-mode .pdf-data-grid {
        display: grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 10px !important;
    }

    /* Tighter Headers */
    .pdf-mode .pdf-sidebar-data h4 {
        font-size: 9px !important;
        color: #006858 !important;
        margin-bottom: 4px !important;
        border-bottom: 1px solid #cbd5e1 !important;
    }

    /* Compact Rows */
    .pdf-mode .pdf-sidebar-data .data-row {
        font-size: 8px !important; /* Very small for print */
        padding: 2px 0 !important;
        border-bottom: 1px dashed #e2e8f0 !important;
        display: flex !important;
        justify-content: space-between !important;
        line-height: 1.2 !important;
    }
    
    /* Remove Shadows for clean print */
    .pdf-mode .shadow-sm, .pdf-mode .shadow-lg { 
        box-shadow: none !important; 
    }
    
    /* Hide inputs in PDF, show clean text */
    .pdf-mode input[type=range] { display: none !important; }
    
    /* Compact Text Sizes */
    .pdf-mode .text-2xl { font-size: 1.1rem !important; } 
    .pdf-mode h2 { font-size: 1.2rem !important; margin: 0 !important;}
    .pdf-mode h3 { font-size: 0.9rem !important; }
    .pdf-mode .p-5, .pdf-mode .p-6 { padding: 8px !important; }
    .pdf-mode .h-[400px] { height: 280px !important; } /* Slightly taller for landscape */
    .pdf-mode .gap-6 { gap: 8px !important; }
    .pdf-mode .space-y-6 { space-y: 8px !important; margin-top: 8px !important;}
    .pdf-mode nav { margin-bottom: 10px !important; padding: 10px !important; border-bottom: 2px solid #006858 !important;}
    
    /* Standard Print Styles (Fallback for Ctrl+P) */
    @media print {
      @page { size: landscape; margin: 5mm; } 
      body { background: white; -webkit-print-color-adjust: exact; }
      .no-print, button, .modal-overlay, .tab-nav { display: none !important; }
      
      #main-report-content { width: 100% !important; max-width: none !important; padding: 0 !important; }
      
      /* Force 4 columns for cards */
      .print-grid { display: grid !important; grid-template-columns: 1fr 1fr 1fr 1fr !important; gap: 8px !important; } 
      
      .pdf-bottom-section {
         display: flex !important;
         flex-direction: row !important;
         justify-content: space-between !important;
         gap: 15px !important;
      }
      
      .pdf-chart-container { width: 60% !important; }
      .pdf-sidebar-data { width: 38% !important; display: block !important; border: 1px solid #eee; padding: 5px; }
      
      /* Ensure Side-by-Side Data tables in Print */
      .pdf-data-grid { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px !important; }

      .print-hidden { display: none !important; }
      .print-visible { display: block !important; }
      
      input[type=range] { display: none !important; }
      .overflow-y-auto { overflow: visible !important; height: auto !important; max-height: none !important; }
      
      /* Specific print sizing overrides */
      .data-row { font-size: 8px !important; border-bottom: 1px solid #eee; padding: 1px 0; }
      h4 { font-size: 10px !important; font-weight: bold; margin-bottom: 5px; color: #006858; }
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useLayoutEffect } = React;

    // --- ICONS COMPONENT ---
    const Icon = ({ name, size = 18, className = "" }) => {
      return <i data-lucide={name} width={size} height={size} className={className}></i>;
    };

    // --- HELPER: FORMAT CURRENCY ---
    const formatEuro = (amount) => {
      return new Intl.NumberFormat('en-IE', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(amount);
    };

    // --- HELPER: S-CURVE GENERATOR ---
    const generateSLine = (total, periods) => {
      const data = [];
      for (let i = 1; i <= periods; i++) {
        const x = (i / periods) * 10 - 5; 
        const val = 1 / (1 + Math.exp(-x));
        data.push(val);
      }
      const lastVal = data[data.length - 1];
      const normalized = data.map(v => Math.round((v / lastVal) * total));
      const periodic = normalized.map((v, i) => i === 0 ? v : v - normalized[i - 1]);
      return { cumulative: normalized, periodic };
    };

    // --- COMPONENT: MONEY INPUT ---
    const MoneyInput = ({ value, onChange, className, placeholder, disabled }) => {
      const [localValue, setLocalValue] = useState('');
      const inputRef = useRef(null);

      useEffect(() => {
        if (document.activeElement !== inputRef.current) {
            if (value === undefined || value === null || value === '') {
                setLocalValue('');
            } else {
                setLocalValue(Number(value).toLocaleString('en-IE'));
            }
        }
      }, [value]);

      const handleChange = (e) => {
        if (disabled) return;
        const raw = e.target.value;
        setLocalValue(raw); 
        const cleanVal = raw.replace(/,/g, '');
        if (cleanVal === '') {
             onChange(0);
        } else if (!isNaN(cleanVal)) {
             onChange(parseFloat(cleanVal));
        }
      };

      const handleBlur = () => {
         const cleanVal = localValue.replace(/,/g, '');
         if (!isNaN(cleanVal) && cleanVal !== '') {
             setLocalValue(Number(cleanVal).toLocaleString('en-IE'));
         } else {
             setLocalValue('');
         }
      };

      return (
        <input
          ref={inputRef}
          type="text"
          inputMode="decimal"
          value={localValue}
          onChange={handleChange}
          onBlur={handleBlur}
          className={`${className} ${disabled ? 'bg-slate-100 text-slate-500 cursor-not-allowed' : ''}`}
          placeholder={placeholder}
          disabled={disabled}
        />
      );
    };

    // --- MODAL COMPONENT ---
    const Modal = ({ isOpen, onClose, title, children }) => {
      if (!isOpen) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 modal-overlay">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden animate-fade-in">
            <div className="px-6 py-4 border-b flex justify-between items-center bg-slate-50">
              <h3 className="font-bold text-slate-800">{title}</h3>
              <button onClick={onClose} className="p-1 hover:bg-slate-200 rounded-full transition"><Icon name="x" size={20} /></button>
            </div>
            <div className="p-6 max-h-[80vh] overflow-y-auto custom-scroll">
              {children}
            </div>
          </div>
        </div>
      );
    };

    // --- TOOLTIP COMPONENT ---
    const Tooltip = ({ text }) => (
      <div className="group relative inline-block ml-2 cursor-help no-print z-50">
        <Icon name="info" size={14} className="text-slate-400 hover:text-[#006858]" />
        <div className="invisible group-hover:visible opacity-0 group-hover:opacity-100 transition-opacity absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 bg-slate-800 text-white text-[10px] rounded w-56 text-center shadow-lg pointer-events-none z-50">
          {text}
          <div className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-800"></div>
        </div>
      </div>
    );

    function App() {
      // --- STATE & DATA ---
      const STORAGE_KEY = 'HSE_CASHFLOW_V29'; 
      
      const [config, setConfig] = useState(() => {
        if (window.HSE_PRELOADED_DATA && window.HSE_PRELOADED_DATA.config) return window.HSE_PRELOADED_DATA.config;
        const saved = localStorage.getItem(STORAGE_KEY);
        return saved ? JSON.parse(saved) : {
          projectName: 'Capital Project A',
          budget: 2500000,
          duration: 24,
          contingencyPercent: 10,
          milestones: [{ month: 6, label: 'Planning Permission' }, { month: 12, label: 'Shell Complete' }]
        };
      });

      const [actuals, setActuals] = useState(() => {
        if (window.HSE_PRELOADED_DATA && window.HSE_PRELOADED_DATA.actuals) return window.HSE_PRELOADED_DATA.actuals;
        const saved = localStorage.getItem(STORAGE_KEY + '_ACTUALS');
        if (saved) return JSON.parse(saved);
        return [
            { value: 25000, comment: 'Initial Mobilisation' },
            { value: 12500, comment: '' },
            { value: 25000, comment: '' },
            { value: 32000, comment: '' }
        ];
      });

      const [customPlanned, setCustomPlanned] = useState(() => {
        if (window.HSE_PRELOADED_DATA && window.HSE_PRELOADED_DATA.customPlanned) return window.HSE_PRELOADED_DATA.customPlanned;
        const saved = localStorage.getItem(STORAGE_KEY + '_CUSTOM_PLANNED');
        return saved ? JSON.parse(saved) : null;
      });

      const [progress, setProgress] = useState(() => {
        if (window.HSE_PRELOADED_DATA && window.HSE_PRELOADED_DATA.progress) return window.HSE_PRELOADED_DATA.progress;
        const saved = localStorage.getItem(STORAGE_KEY + '_PROGRESS');
        return saved ? Number(saved) : 20;
      });

      const [isSettingsOpen, setIsSettingsOpen] = useState(false);
      const [activeTab, setActiveTab] = useState('logs');
      const [showPerformanceView, setShowPerformanceView] = useState(false);
      const [isPdfGenerating, setIsPdfGenerating] = useState(false);

      useEffect(() => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
        localStorage.setItem(STORAGE_KEY + '_ACTUALS', JSON.stringify(actuals));
        localStorage.setItem(STORAGE_KEY + '_CUSTOM_PLANNED', JSON.stringify(customPlanned));
        localStorage.setItem(STORAGE_KEY + '_PROGRESS', progress);
      }, [config, actuals, customPlanned, progress]);

      useEffect(() => {
        if (window.lucide) window.lucide.createIcons();
      }, [activeTab, isSettingsOpen, actuals.length, config.milestones.length, config, customPlanned, showPerformanceView, progress, isPdfGenerating]);

      useEffect(() => {
        if (customPlanned) {
            const planTotal = customPlanned.reduce((sum, item) => sum + (item.value || 0), 0);
            if (Math.abs(planTotal - config.budget) > 0.01) {
                setConfig(prev => ({ ...prev, budget: planTotal }));
            }
        }
      }, [customPlanned, config.budget]);

      // --- CALCULATIONS ---

      const baseline = useMemo(() => {
        if (customPlanned) {
            const cumulative = [];
            let sum = 0;
            const periodic = customPlanned.map((item) => {
                const val = item.value || 0;
                sum += val;
                cumulative.push(sum);
                return val;
            });
            return { periodic, cumulative, isCustom: true, total: sum, rawData: customPlanned };
        }
        const sCurve = generateSLine(config.budget, config.duration);
        return { ...sCurve, isCustom: false, total: config.budget, rawData: sCurve.periodic.map(v => ({ value: v, comment: '' })) };
      }, [config.budget, config.duration, customPlanned]);

      const stats = useMemo(() => {
        const ac = actuals.reduce((a, b) => a + (b.value || 0), 0); 
        const monthIndex = actuals.length - 1;
        const pv = monthIndex >= 0 && monthIndex < baseline.cumulative.length ? baseline.cumulative[monthIndex] : 0; 
        
        // EV Calculation
        const ev = baseline.total * (progress / 100); 
        const cpi = ac > 0 ? ev / ac : 1;
        const spi = pv > 0 ? ev / pv : 1; 
        
        // Variance
        const costVariance = ac - pv;
        const costVariancePercent = pv > 0 ? (costVariance / pv) * 100 : 0;

        // 1. CASH FLOW TREND
        let avgMonthlyVariance = 0;
        if (monthIndex >= 0) {
            const currentVariance = ac - pv; 
            const monthsElapsed = monthIndex + 1;
            avgMonthlyVariance = currentVariance / monthsElapsed;
        }
        const remainingMonths = Math.max(0, config.duration - (monthIndex + 1));
        const projectedVariance = avgMonthlyVariance * remainingMonths;
        const totalProjectedVariance = (ac - pv) + projectedVariance;
        const eacTrend = baseline.total + totalProjectedVariance;

        // 2. EFFICIENCY FORECAST (Standard EVM)
        const safeCPI = cpi === 0 ? 0.001 : cpi; // Prevent divide by zero only
        const eacEfficiency = config.budget / safeCPI;

        // Primary is ALWAYS efficiency
        const eacPrimary = eacEfficiency;
        const eacLabel = "Based on Efficiency (CPI)";

        const variance = eacPrimary - baseline.total;
        const variancePercent = baseline.total > 0 ? (variance / baseline.total) * 100 : 0;
        
        let statusColor = 'text-emerald-600';
        if (variancePercent > config.contingencyPercent) statusColor = 'text-red-600';
        else if (variancePercent > 0) statusColor = 'text-amber-500';

        const projectedCPI = eacPrimary > 0 ? config.budget / eacPrimary : cpi;
        const projectedDuration = spi > 0 ? config.duration / spi : config.duration;
        const projectedDelay = projectedDuration - config.duration;

        return { 
            ac, pv, ev, 
            cpi, spi, costVariance, costVariancePercent,
            eacPrimary, eacTrend, eacEfficiency, eacLabel, 
            variance, variancePercent, statusColor, avgMonthlyVariance,
            projectedCPI, projectedDuration, projectedDelay
        };
      }, [actuals, baseline, config, progress]);

      const timeAlert = useMemo(() => {
        if (stats.spi >= 0.98 || stats.spi === 0) return null;
        const delayMonths = stats.projectedDelay;
        return delayMonths >= 1.0 ? { monthsLate: Math.round(delayMonths), newDuration: Math.round(stats.projectedDuration) } : null;
      }, [stats.spi, stats.projectedDuration, stats.projectedDelay]);

      // --- CHART ---
      const chartRef = useRef(null);
      useEffect(() => {
        // We render two charts potentially: one main, one for PDF ghost
        // The PDF ghost chart logic is handled by the PDF generator creating a static snapshot
        // But we need to make sure the Main Chart is live
        const ctx = document.getElementById('mainChart');
        if (!ctx) return;
        if (chartRef.current) chartRef.current.destroy();

        const currentMonthCount = actuals.length;
        const maxMonth = showPerformanceView ? Math.max(currentMonthCount, 1) : config.duration;
        const labels = Array.from({ length: maxMonth }, (_, i) => `Month ${i + 1}`);

        const actualsPlot = new Array(maxMonth).fill(null);
        let runSum = 0;
        actuals.forEach((item, i) => {
            if (i < maxMonth) actualsPlot[i] = (runSum += item.value);
        });

        const planData = baseline.cumulative.slice(0, maxMonth);

        let cleanForecastPlot = [];
        if (!showPerformanceView) {
            const forecastPlot = new Array(config.duration).fill(null);
            const lastActualIndex = actuals.length - 1;
            const remainingMonths = config.duration - actuals.length;

            if (remainingMonths > 0) {
                forecastPlot[lastActualIndex] = stats.ac; 
                const futureBaselinePeriodic = baseline.periodic.slice(actuals.length);
                let accumulatedForecast = stats.ac;
                
                // FORECAST LINE LOGIC - LOCKED TO EFFICIENCY
                for(let i=0; i < remainingMonths; i++) {
                    const costFactor = stats.cpi > 0.1 ? (1 / stats.cpi) : 1;
                    const monthlyPrediction = futureBaselinePeriodic[i] * costFactor;
                    accumulatedForecast += monthlyPrediction;
                    forecastPlot[actuals.length + i] = accumulatedForecast;
                }
            }
            cleanForecastPlot = forecastPlot.map((v, i) => i < lastActualIndex ? null : v);
        }

        const milestoneAnnotations = {};
        config.milestones.forEach((m, i) => {
            if (m.month <= maxMonth) {
                milestoneAnnotations[`m${i}`] = {
                    type: 'line', xMin: m.month - 1, xMax: m.month - 1,
                    borderColor: '#cbd5e1', borderDash: [4, 4], borderWidth: 2,
                    label: { display: true, content: m.label, position: 'start', backgroundColor: '#f1f5f9', color: '#64748b', font: {size: 10} }
                };
            }
        });

        const datasets = [
              { type: 'line', label: 'Plan', data: planData, borderColor: '#94a3b8', borderDash: [5,5], borderWidth: 2, pointRadius: showPerformanceView ? 3 : 0, tension: 0.4, order: 2 },
              { type: 'line', label: 'Actual', data: actualsPlot, borderColor: '#006858', backgroundColor: '#006858', borderWidth: 3, pointRadius: 5, tension: 0.1, order: 1 }
        ];

        if (!showPerformanceView) {
            datasets.push({ type: 'line', label: 'Forecast (EVM)', data: cleanForecastPlot, borderColor: '#f59e0b', borderDash: [2,2], borderWidth: 2, pointRadius: 0, tension: 0.4, spanGaps: true, order: 1 });
        }

        const chartConfig = {
          data: { labels, datasets: datasets },
          options: {
            responsive: true, maintainAspectRatio: false,
            animation: false, // Disable animation for easier PDF capture
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { position: 'bottom', labels: { boxWidth: 10, padding: 10, font: {size: 10} } },
              tooltip: {
                  backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8,
                  callbacks: { 
                      label: (c) => ` ${c.dataset.label}: ${formatEuro(c.raw)}`,
                      afterBody: (tooltipItems) => {
                          const idx = tooltipItems[0].dataIndex;
                          if (idx < actuals.length) {
                             const actualMonthly = actuals[idx] ? actuals[idx].value : 0;
                             const planMonthly = baseline.periodic[idx];
                             const monthlyDiff = actualMonthly - planMonthly;
                             const monthlyPct = planMonthly > 0 ? (monthlyDiff / planMonthly) * 100 : 0;
                             return [
                                 `------------------`,
                                 `Mth Var: ${monthlyDiff > 0 ? '+' : ''}${formatEuro(monthlyDiff)} (${monthlyDiff > 0 ? '+' : ''}${monthlyPct.toFixed(1)}%)`
                             ];
                          }
                          return [];
                      }
                  } 
              },
              annotation: { annotations: milestoneAnnotations }
            },
            scales: {
              y: { ticks: { callback: (v) => '€' + (v/1000000).toFixed(1) + 'm', font: {size: 10} }, grid: { color: '#f1f5f9' } },
              x: { grid: { display: false }, ticks: { font: {size: 10} } }
            }
          }
        };

        chartRef.current = new Chart(ctx, chartConfig);
        
        // --- HELPER FOR PDF CHART ---
        // We attach the config to the window so the clone can access it easily to recreate the chart
        window.currentChartConfig = chartConfig;

      }, [config, actuals, stats, baseline, showPerformanceView]);

      const handleDownloadCSV = () => {
        const headers = ["Month", "Planned (M)", "Planned (C)", "Actual (M)", "Actual (C)", "Var %"];
        let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
        let acCum = 0;
        baseline.cumulative.forEach((pvC, idx) => {
           const ac = actuals[idx] ? actuals[idx].value : 0;
           if(actuals[idx]) acCum += ac;
           csvContent += [`Month ${idx+1}`, baseline.periodic[idx].toFixed(2), pvC.toFixed(2), actuals[idx] ? ac : "", actuals[idx] ? acCum : "", actuals[idx] ? (((ac - baseline.periodic[idx])/baseline.periodic[idx])*100).toFixed(2) + '%' : ''].join(",") + "\n";
        });
        const link = document.createElement("a");
        link.href = encodeURI(csvContent);
        link.download = `${config.projectName.replace(/\s+/g, '_')}_Cashflow.csv`;
        link.click();
      };

      // --- HIGH QUALITY SNAPSHOT PDF GENERATOR (LANDSCAPE) ---
      const handleDownloadPDF = async () => {
        setIsPdfGenerating(true);
        
        // 1. Create a deep clone of the report element
        const originalElement = document.getElementById('main-report-content');
        const clone = originalElement.cloneNode(true);
        
        // 2. Setup the Ghost Container (WAY Off-screen to prevent jump)
        const ghostContainer = document.createElement('div');
        ghostContainer.style.position = 'fixed';
        ghostContainer.style.left = '-5000px'; 
        ghostContainer.style.top = '0';
        ghostContainer.style.zIndex = '-100';
        
        // 3. Apply the PDF Mode class to the clone (Compact styles)
        clone.classList.add('pdf-mode');
        ghostContainer.appendChild(clone);
        document.body.appendChild(ghostContainer);

        // 4. Re-render Canvas in Clone
        const oldCanvas = originalElement.querySelector('canvas');
        const newCanvas = clone.querySelector('canvas');
        if (oldCanvas && newCanvas && window.currentChartConfig) {
             // We need to wait a tick for the clone to be in DOM
             await new Promise(r => setTimeout(r, 100));
             new Chart(newCanvas, {
                 ...window.currentChartConfig,
                 options: { 
                     ...window.currentChartConfig.options, 
                     animation: false,
                     responsive: false // Important for fixed size export
                 }
             });
             // Add a small paint delay to ensure chart is rendered before snapshot
             await new Promise(r => setTimeout(r, 200));
        }
        
        // 5. Generate PDF from Ghost (LANDSCAPE)
        const opt = {
          margin: [10, 10, 10, 10], // Margins: Top, Left, Bottom, Right
          filename: `${config.projectName.replace(/\s+/g, '_')}_Report.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          // SCALE 4 is the key for "High Quality" - higher res image
          html2canvas: { scale: 4, useCORS: true, logging: false, scrollY: 0 },
          // Change to LANDSCAPE
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' },
          pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        try {
            await html2pdf().set(opt).from(clone).save();
        } catch(e) {
            console.error("PDF Generation Error", e);
            alert("Error generating PDF. Please check console.");
        } finally {
             // 6. Cleanup
             document.body.removeChild(ghostContainer);
             setIsPdfGenerating(false);
        }
      };

      const handleNativePrint = () => {
          window.print();
      };

      // --- SAVE HANDLER (File) ---
      const handleSaveHTML = async () => {
        const data = { config, actuals, customPlanned, progress };
        // Minify JSON to save space
        const safeJson = JSON.stringify(data).replace(/<\/script>/g, '<\\/script>');
        
        const clone = document.documentElement.cloneNode(true);
        const oldScript = clone.querySelector('script#hse-preloaded-data');
        if (oldScript) oldScript.remove();
        
        const root = clone.querySelector('#root');
        if (root) root.innerHTML = ''; // This wipes the rendered app, preventing duplication
        
        const newScript = document.createElement('script');
        newScript.id = 'hse-preloaded-data';
        newScript.textContent = `window.HSE_PRELOADED_DATA = ${safeJson};`;
        
        const head = clone.querySelector('head');
        head.appendChild(newScript);
        
        const finalHtml = '<!DOCTYPE html>\n' + clone.outerHTML;

        if (window.showSaveFilePicker) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: `${config.projectName.replace(/[^a-z0-9]/gi, '_')}_HSE_Report.html`,
                    types: [{ description: 'HTML Project File', accept: { 'text/html': ['.html'] } }],
                });
                const writable = await handle.createWritable();
                await writable.write(finalHtml);
                await writable.close();
                return;
            } catch (err) { if (err.name === 'AbortError') return; }
        }

        const blob = new Blob([finalHtml], {type: 'text/html'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${config.projectName.replace(/[^a-z0-9]/gi, '_')}_HSE_Report.html`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      };

      const handleFactoryReset = () => {
         if (!confirm("Wipe all data?")) return;
         setConfig({ projectName: 'New Project', budget: 0, duration: 12, milestones: [], contingencyPercent: 10 });
         setActuals([]); setCustomPlanned(null); setProgress(0); setIsSettingsOpen(false);
      };

      const calculatePlannedProgress = (currentMonthCount) => {
         if (currentMonthCount === 0 || baseline.total === 0) return 0;
         const planCumul = baseline.cumulative[Math.min(currentMonthCount - 1, baseline.cumulative.length - 1)];
         return Math.min(Number(((planCumul / baseline.total) * 100).toFixed(2)), 100);
      };

      const plannedProgressToDate = useMemo(() => {
          return calculatePlannedProgress(actuals.length);
      }, [actuals.length, baseline]);

      const addActualMonth = () => {
          if (actuals.length < config.duration) {
              const nextIndex = actuals.length;
              const newA = [...actuals, { value: Math.round(baseline.periodic[nextIndex] || 0), comment: '' }];
              setActuals(newA);
              const newProgress = calculatePlannedProgress(newA.length);
              setProgress(newProgress);
          }
      };

      const ensureCustomMode = () => {
          if (!customPlanned) {
              const init = baseline.periodic.map(v => ({ value: v, comment: '' }));
              setCustomPlanned(init); return init;
          }
          return [...customPlanned];
      };

      const resetProgressToPlan = () => { setProgress(plannedProgressToDate); };

      const displayCPI = showPerformanceView ? stats.cpi : stats.projectedCPI;
      const displayDuration = showPerformanceView ? stats.spi.toFixed(2) : Math.round(stats.projectedDuration) + " Mo";
      const cpiStatus = displayCPI >= 1 ? 'text-emerald-600' : 'text-red-600';
      
      const eacDelta = stats.eacEfficiency - stats.eacTrend;
      const showRiskWarning = eacDelta > (config.budget * 0.02); 

      const durationDelta = Math.round(stats.projectedDuration - config.duration);
      const isDelayed = durationDelta > 0;
      const isAhead = durationDelta < 0;

      return (
        <div className="min-h-screen pb-20 print:pb-0">
          <nav className="bg-[#006858] text-white px-6 py-4 shadow-lg print:shadow-none">
            <div className="max-w-7xl mx-auto flex justify-between items-center">
              <div className="flex items-center gap-4">
                <div className="bg-white p-1 rounded"><img src="https://www.esther.ie/wp-content/uploads/2022/05/HSE-Logo-Green-NEW-no-background.png" alt="HSE" className="h-8" /></div>
                <div><h1 className="text-xl font-bold">HSE Capital & Estates</h1><p className="text-[10px] opacity-75 uppercase tracking-wider">Analysis v2.93</p></div>
              </div>
              <div className="flex gap-2 no-print">
                <button onClick={() => setIsSettingsOpen(true)} className="px-3 py-2 bg-white/10 rounded-lg text-sm border border-white/10 hover:bg-white/20 transition"><Icon name="settings" size={16} /></button>
                <button onClick={handleSaveHTML} className="px-3 py-2 bg-emerald-700 rounded-lg text-sm border border-white/20 hover:bg-emerald-600 transition shadow-md flex items-center gap-2"><Icon name="save" size={16} /> Save</button>
                
                {/* SPLIT BUTTON: DOWNLOAD & PRINT */}
                <div className="flex rounded-lg bg-white/10 border border-white/10 overflow-hidden">
                    <button onClick={handleDownloadPDF} disabled={isPdfGenerating} className="px-3 py-2 hover:bg-white/20 transition flex items-center gap-2 border-r border-white/10">
                        {isPdfGenerating ? <Icon name="loader" size={16} className="animate-spin" /> : <Icon name="download" size={16} />} 
                        <span className="text-xs font-bold">{isPdfGenerating ? "Generating..." : "Report"}</span>
                    </button>
                    <button onClick={handleNativePrint} className="px-3 py-2 hover:bg-white/20 transition flex items-center gap-2" title="Open Native Print Dialog (Best for Vector PDF)">
                         <Icon name="printer" size={16} />
                    </button>
                </div>

              </div>
            </div>
          </nav>

          {/* MAIN CONTENT WRAPPER FOR PDF GENERATION */}
          <main id="main-report-content" className={`max-w-7xl mx-auto p-6 space-y-6`}>
            <div className="flex justify-between items-end border-b border-slate-200 pb-4">
               <div><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Project Name</span><h2 className="text-2xl font-black text-slate-800">{config.projectName}</h2></div>
               <div className="text-right"><div className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Report Date</div><div className="font-bold text-slate-700">{new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</div></div>
            </div>
            
            <div className={`grid grid-cols-2 lg:grid-cols-4 gap-4 print-grid pdf-grid pdf-top-cards`}>
               
               {/* Card 1: Budget */}
               <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 pdf-shadow-none pdf-compact-card">
                  <span className="text-[10px] font-black text-slate-400 uppercase tracking-wider">
                      {showPerformanceView ? 'Planned to Date (PV)' : 'Budget (BAC)'}
                  </span>
                  <div className="text-2xl font-bold text-slate-800">
                      {formatEuro(showPerformanceView ? stats.pv : config.budget)}
                  </div>
                  <div className="text-xs text-slate-500 mt-1">
                      {showPerformanceView ? `Month 1 to ${actuals.length}` : `${config.duration} Months Total`}
                  </div>
               </div>
               
               {/* Card 2: Projected */}
               <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative group pdf-shadow-none pdf-compact-card">
                   {showPerformanceView ? (
                       <>
                           <div className="flex items-center">
                             <span className="text-[10px] font-black text-slate-400 uppercase tracking-wider">Spent to Date (AC)</span>
                             <Tooltip text="Total actual expenditure logged so far." />
                           </div>
                           <div className={`text-2xl font-bold ${stats.statusColor}`}>{formatEuro(stats.ac)}</div>
                           <div className="text-xs text-slate-500 mt-1">Actuals vs Plan Period</div>
                       </>
                   ) : (
                       <>
                           <div className="flex justify-between items-start">
                               <div className="flex items-center gap-1">
                                   <span className="text-[10px] font-black text-slate-400 uppercase tracking-wider">Projected (EAC)</span>
                                   <Tooltip text="Standard EVM Forecast based on current Efficiency (CPI)." />
                               </div>
                           </div>
                           
                           <div className={`text-2xl font-bold ${stats.statusColor} transition-all`}>
                               {formatEuro(stats.eacPrimary)}
                           </div>
                           
                           <div className="flex items-center justify-between mt-1">
                               <span className="text-[10px] font-bold text-slate-500">{stats.eacLabel}</span>
                               {showRiskWarning && (
                                   <span className="text-[9px] bg-red-50 text-red-600 px-1.5 rounded border border-red-100 font-bold" title={`Difference between efficiency-based EAC and cash-trend EAC`}>
                                       Efficiency Gap: +{formatEuro(eacDelta)}
                                   </span>
                               )}
                           </div>
                           
                           <div className="mt-2 pt-2 border-t border-slate-100">
                               <div className="flex justify-between text-[10px] text-slate-400">
                                   <div className="flex items-center gap-1">
                                       <span>Cash Trend:</span>
                                       {/* NEW INFO ICON FOR BURN RATE */}
                                       <Tooltip text="Burn Rate Forecast: How much the project will cost if your current monthly spending rate continues to the end." />
                                   </div>
                                   <span className="font-mono text-slate-600">{formatEuro(stats.eacTrend)}</span>
                               </div>
                           </div>
                       </>
                   )}
               </div>

               {/* Card 3: CPI - NOW WITH VARIANCE % */}
               <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 relative pdf-shadow-none pdf-compact-card">
                   <div className={`absolute top-0 right-0 p-2 opacity-10 ${cpiStatus}`}>
                      <Icon name="trending-up" size={48} />
                   </div>
                  <div className="flex items-center">
                     <span className="text-[10px] font-black text-slate-400 uppercase tracking-wider">
                        {showPerformanceView ? 'Current Efficiency (CPI)' : 'Projected Final CPI'}
                     </span>
                     <Tooltip text={showPerformanceView ? "Cost Performance Index (EV/AC). < 1.0 means for every €1 spent, you got less than €1 of value." : "Predicted CPI at completion."} />
                  </div>
                  <div className={`text-2xl font-bold ${cpiStatus}`}>
                      {displayCPI.toFixed(2)}
                  </div>

                  <div className="flex justify-between items-end mt-1">
                      <div className="text-xs font-medium text-slate-500">
                          {displayCPI >= 1 ? 'Efficient Spend' : 'Inefficient Spend'}
                      </div>
                      
                      {/* --- CASH VARIANCE DISPLAY WITH % --- */}
                      <div className={`text-xs font-bold ${stats.costVariance > 0 ? 'text-red-600' : 'text-emerald-600'} text-right`}>
                           <div>
                               Var: {stats.costVariance > 0 ? '+' : ''}{formatEuro(stats.costVariance)}
                           </div>
                           <div className="text-[10px]">
                               ({stats.costVariance > 0 ? '+' : ''}{Math.round(stats.costVariancePercent)}%)
                           </div>
                      </div>
                  </div>
               </div>

               {/* Card 4: SPI */}
               <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between pdf-shadow-none pdf-compact-card">
                  <div>
                    <div className="flex items-center">
                        <span className="text-[10px] font-black text-slate-400 uppercase tracking-wider">
                            {showPerformanceView ? 'Current Schedule (SPI)' : 'Projected Duration'}
                        </span>
                        <Tooltip text={showPerformanceView ? "Progress vs Plan (EV/PV). < 1.0 means behind schedule." : "Estimated project duration based on current work rate."} />
                    </div>
                    <div className="text-2xl font-bold text-blue-600">
                        {displayDuration}
                    </div>
                    <div className="text-xs text-slate-500 mt-1">
                        {showPerformanceView ? `${progress}% Comp.` : `SPI: ${stats.spi.toFixed(2)}`}
                    </div>
                  </div>
                  
                  {!showPerformanceView && (
                    <div className="mt-3">
                        {isDelayed && (
                            <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-red-50 border border-red-100 rounded text-[10px] font-bold text-red-700 animate-pulse print:animate-none">
                                <Icon name="alert-circle" size={12} />
                                {durationDelta} Months Delay
                            </div>
                        )}
                        {isAhead && (
                            <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-emerald-50 border border-emerald-100 rounded text-[10px] font-bold text-emerald-700">
                                <Icon name="check-circle" size={12} />
                                {Math.abs(durationDelta)} Months Ahead
                            </div>
                        )}
                        {durationDelta === 0 && (
                            <div className="inline-flex items-center gap-1.5 px-2 py-1 bg-slate-50 border border-slate-100 rounded text-[10px] font-bold text-slate-500">
                                <Icon name="check" size={12} />
                                On Schedule
                            </div>
                        )}
                    </div>
                  )}
               </div>
            </div>

            <div className={`grid lg:grid-cols-3 gap-6 print-grid pdf-grid pdf-bottom-section`}>
               <div className="lg:col-span-2 space-y-6 pdf-chart-container">
                  <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 pdf-shadow-none pdf-compact-card">
                    <div className="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-4">
                        <div className="flex flex-col">
                             <h3 className="font-bold text-slate-700 flex items-center gap-2">
                                <Icon name="bar-chart-2" size={18} className="text-[#006858]"/> 
                                {showPerformanceView ? 'Performance to Date' : 'Expenditure Forecast'}
                            </h3>
                            {!showPerformanceView && <span className="text-[10px] text-slate-400 ml-6 uppercase font-bold tracking-wide">Standard EVM Forecast</span>}
                        </div>
                        
                        <div className="flex items-center gap-2 no-print bg-slate-100 p-1 rounded-lg print-hidden">
                           <span className={`text-[10px] font-bold uppercase px-2 py-1 rounded transition ${!showPerformanceView ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-400'}`}>Forecast View</span>
                           <div className="relative inline-block w-10 mr-2 align-middle select-none">
                                <input 
                                    type="checkbox" 
                                    name="toggle" 
                                    id="toggle" 
                                    className="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer transform left-0 border-slate-300"
                                    checked={showPerformanceView}
                                    onChange={() => setShowPerformanceView(!showPerformanceView)}
                                />
                                <label htmlFor="toggle" className="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer"></label>
                           </div>
                           <span className={`text-[10px] font-bold uppercase px-2 py-1 rounded transition ${showPerformanceView ? 'bg-white text-[#006858] shadow-sm' : 'text-slate-400'}`}>Performance View</span>
                        </div>
                    </div>

                    <div className="h-[400px] w-full"><canvas id="mainChart"></canvas></div>
                    
                    <div className="mt-8 bg-slate-50 p-4 rounded-lg border border-slate-100">
                        <div className="flex justify-between items-end mb-2">
                             <div>
                                 <label className="text-xs font-bold text-slate-600 uppercase">Total Project Physical Completion (%)</label>
                                 <div className="text-[10px] text-slate-400 mt-0.5">
                                    Plan expects: <strong>{plannedProgressToDate.toFixed(2)}%</strong> by Month {actuals.length}
                                 </div>
                             </div>
                             <span className={`text-sm font-black ${progress > plannedProgressToDate + 5 ? 'text-emerald-600' : progress < plannedProgressToDate - 5 ? 'text-red-600' : 'text-slate-700'}`}>
                                 {progress.toFixed(2)}%
                             </span>
                        </div>
                        <div className="flex items-center gap-2">
                            <input type="range" min="0" max="100" step="0.01" value={progress} onChange={(e) => setProgress(Number(e.target.value))} className="w-full cursor-pointer print:hidden" />
                            <button onClick={resetProgressToPlan} className="px-2 py-1 bg-white border border-slate-200 text-slate-600 rounded text-[10px] font-bold hover:bg-slate-50 hover:text-[#006858] transition shrink-0 shadow-sm print:hidden" title={`Reset progress to planned ${plannedProgressToDate}%`}>Sync to Plan</button>
                        </div>
                    </div>
                  </div>
                  
                  {timeAlert && !showPerformanceView && (
                    <div className="bg-orange-50 border-l-4 border-orange-500 p-4 rounded shadow-sm flex items-start gap-4">
                        <div className="text-orange-600"><Icon name="clock" size={24} /></div>
                        <div>
                           <h4 className="text-sm font-black text-orange-800 uppercase">Delay Warning</h4>
                           <p className="text-sm text-orange-800">Current SPI suggests a <strong>+{timeAlert.monthsLate} month</strong> delay.</p>
                           <p className="text-xs text-orange-700 mt-1">If this delay causes inefficiency, the final cost could increase by <strong>{formatEuro(stats.eacEfficiency - stats.eacTrend)}</strong> (Efficiency Gap).</p>
                        </div>
                    </div>
                  )}
               </div>

               <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col h-full overflow-hidden print:overflow-visible print:border-none print:shadow-none pdf-shadow-none pdf-compact-card pdf-sidebar-data">
                  
                  {/* TABS (Hidden during PDF Generation) */}
                  <div className="flex border-b border-slate-100 tab-nav print-hidden">
                     {['logs', 'planned', 'milestones'].map(t => (
                        <button key={t} onClick={() => setActiveTab(t)} className={`flex-1 py-3 text-[10px] font-bold uppercase transition-colors ${activeTab === t ? 'text-[#006858] border-b-2 border-[#006858]' : 'text-slate-400 hover:text-slate-600'}`}>{t}</button>
                     ))}
                  </div>

                  {/* SCREEN VIEW (SCROLLABLE) - Hidden during PDF generation via class 'print-hidden' */}
                  <div className="p-4 flex-1 overflow-y-auto max-h-[500px] custom-scroll bg-slate-50/50 print:hidden print-hidden">
                     {activeTab === 'logs' && (
                        <div className="space-y-3">
                           {actuals.map((item, i) => (
                             <div key={i} className="flex flex-col gap-1 bg-white p-2 rounded-lg border border-slate-100 shadow-sm animate-fade-in-up">
                                <div className="flex items-center gap-2">
                                   <div className="w-12 h-8 rounded bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-400 uppercase">M{i+1}</div>
                                   <div className="flex-1 relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-300 text-xs">€</span><MoneyInput value={item.value} onChange={(v) => { const n = [...actuals]; n[i].value = v; setActuals(n); }} className="w-full pl-5 pr-2 py-1.5 text-sm border border-slate-200 rounded outline-none focus:border-[#006858]" /></div>
                                   <button onClick={() => { const n = actuals.filter((_, idx) => idx !== i); setActuals(n); setProgress(calculatePlannedProgress(n.length)); }} className="p-2 text-slate-200 hover:text-red-500 transition no-print"><Icon name="trash-2" size={16} /></button>
                                </div>
                                <input type="text" placeholder="Comment..." value={item.comment || ''} onChange={(e) => { const n = [...actuals]; n[i].comment = e.target.value; setActuals(n); }} className="w-full text-[10px] text-slate-500 bg-slate-50/50 px-2 py-1 rounded border-transparent focus:border-slate-200 outline-none" />
                             </div>
                           ))}
                           {actuals.length < config.duration && <button onClick={addActualMonth} className="w-full py-3 border-2 border-dashed border-slate-200 rounded text-slate-400 text-[10px] font-bold uppercase hover:border-[#006858] hover:text-[#006858] transition">+ Log Month {actuals.length+1}</button>}
                        </div>
                     )}

                     {activeTab === 'planned' && (
                        <div className="space-y-3">
                           {(customPlanned || baseline.rawData).map((item, i) => (
                             <div key={i} className="flex flex-col gap-1 bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
                                <div className="flex items-center gap-2">
                                   <div className="w-12 h-8 rounded bg-slate-100 flex items-center justify-center text-[10px] font-bold text-slate-400">M{i+1}</div>
                                   <div className="flex-1 relative"><span className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-300 text-xs">€</span><MoneyInput value={item.value} onChange={(v) => { const n = ensureCustomMode(); n[i].value = v; setCustomPlanned(n); }} className="w-full pl-5 pr-2 py-1.5 text-sm border border-slate-200 rounded outline-none focus:border-[#006858]" /></div>
                                   <button onClick={() => { const n = ensureCustomMode(); if(n.length>1){n.splice(i,1); setCustomPlanned(n); setConfig({...config, duration: n.length});} }} className="p-2 text-slate-200 hover:text-red-500 transition no-print"><Icon name="trash-2" size={16} /></button>
                                </div>
                                <input type="text" placeholder="Plan note..." value={item.comment || ''} onChange={(e) => { const n = ensureCustomMode(); n[i].comment = e.target.value; setCustomPlanned(n); }} className="w-full text-[10px] text-slate-500 bg-slate-50/50 px-2 py-1 rounded outline-none" />
                             </div>
                           ))}
                           <button onClick={() => { const n = ensureCustomMode(); n.push({value:0,comment:''}); setCustomPlanned(n); setConfig({...config, duration: n.length}); }} className="w-full py-3 border-2 border-dashed border-slate-200 rounded text-slate-400 text-[10px] font-bold uppercase hover:text-[#006858] hover:border-[#006858]">+ Add Planned Month</button>
                        </div>
                     )}

                     {activeTab === 'milestones' && (
                        <div className="space-y-3">
                           {config.milestones.map((m, i) => (
                              <div key={i} className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm space-y-2">
                                 <div className="flex items-center gap-2"><span className="text-[10px] font-bold text-slate-400 uppercase">Month</span><input type="number" value={m.month} onChange={(e) => { const n = [...config.milestones]; n[i].month = Number(e.target.value); setConfig({...config, milestones: n}); }} className="w-16 border-b text-sm font-bold outline-none focus:border-[#006858]" /></div>
                                 <input type="text" value={m.label} onChange={(e) => { const n = [...config.milestones]; n[i].label = e.target.value; setConfig({...config, milestones: n}); }} className="w-full text-sm outline-none border-b border-transparent focus:border-slate-300" placeholder="Milestone Name" />
                                 <button onClick={() => setConfig({...config, milestones: config.milestones.filter((_, idx) => idx !== i)})} className="text-[10px] text-red-400 font-bold hover:underline">Delete</button>
                              </div>
                           ))}
                           <button onClick={() => setConfig({...config, milestones: [...config.milestones, {month: 12, label: 'New Milestone'}]})} className="w-full py-2 bg-emerald-50 rounded text-emerald-700 text-xs font-bold hover:bg-emerald-100">+ Add Milestone</button>
                        </div>
                     )}
                  </div>
                  
                  {/* PRINT & PDF VIEW (SIDE BY SIDE DATA) */}
                  <div className="hidden print:block print-visible p-0 text-xs pdf-data-grid">
                     <div className="mb-0">
                        <h4 className="font-bold text-slate-700 border-b mb-2 pb-1 uppercase">Actuals Log</h4>
                        {actuals.map((item, i) => (
                          <div key={i} className="data-row flex justify-between py-1 border-b border-slate-100">
                             <span className="font-mono text-slate-500 w-8">M{i+1}</span>
                             <span className="font-bold">{formatEuro(item.value)}</span>
                          </div>
                        ))}
                     </div>
                     <div>
                        <h4 className="font-bold text-slate-700 border-b mb-2 pb-1 uppercase">Planned Data</h4>
                        {(customPlanned || baseline.rawData).slice(0, Math.min(config.duration, 24)).map((item, i) => (
                          <div key={i} className="data-row flex justify-between py-1 border-b border-slate-100">
                             <span className="font-mono text-slate-500 w-8">M{i+1}</span>
                             <span className="font-bold">{formatEuro(item.value)}</span>
                          </div>
                        ))}
                        {config.duration > 24 && <div className="text-center italic text-slate-400 mt-2">... {config.duration - 24} more months</div>}
                     </div>
                  </div>

                  <div className="p-4 border-t bg-slate-50 no-print print-hidden"><button onClick={handleDownloadCSV} className="w-full py-2 bg-white border rounded text-slate-700 text-sm font-bold shadow-sm hover:text-[#006858] transition flex items-center justify-center gap-2"><Icon name="download" size={16} /> Export CSV</button></div>
               </div>
            </div>
            
            <footer className="max-w-7xl mx-auto px-6 py-6 text-center text-[10px] text-slate-400 no-print print-hidden">
               <p>© {new Date().getFullYear()} HSE Capital & Estates | Created by Dave Maher</p>
               <p>Intellectual Property of Dave Maher. All rights reserved.</p>
            </footer>

          </main>

          <Modal isOpen={isSettingsOpen} onClose={() => setIsSettingsOpen(false)} title="Project Configuration">
            <div className="space-y-4">
              <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1">Project Name</label><input type="text" value={config.projectName} onChange={(e) => setConfig({...config, projectName: e.target.value})} className="w-full p-2 border rounded outline-none focus:ring-1 focus:ring-[#006858]" /></div>
              <div className="grid grid-cols-2 gap-4">
                <div>
                    <label className="text-[10px] font-black text-slate-400 uppercase block mb-1">Budget (€)</label>
                    <MoneyInput value={config.budget} onChange={(v) => setConfig({...config, budget: v})} disabled={!!customPlanned} className="w-full p-2 border rounded outline-none focus:ring-1 focus:ring-[#006858]" />
                    {customPlanned && <p className="text-[10px] text-emerald-600 mt-1 italic">Synced to Custom Plan</p>}
                </div>
                <div><label className="text-[10px] font-black text-slate-400 uppercase block mb-1">Duration (Months)</label><input type="number" value={config.duration} onChange={(e) => setConfig({...config, duration: Number(e.target.value)})} className="w-full p-2 border rounded outline-none focus:ring-1 focus:ring-[#006858]" /></div>
              </div>
              <div className="bg-amber-50 p-3 rounded-lg border border-amber-100 space-y-2">
                 <h4 className="text-xs font-bold text-amber-800 flex items-center gap-1"><Icon name="alert-triangle" size={12}/> Reset Project</h4>
                 <button onClick={handleFactoryReset} className="w-full py-2 bg-red-600 text-white rounded text-[10px] font-bold hover:bg-red-700 transition">Factory Reset</button>
              </div>
              <button onClick={() => setIsSettingsOpen(false)} className="w-full py-3 bg-[#006858] text-white rounded-lg font-bold shadow-lg">Save Settings</button>
            </div>
          </Modal>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
