<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE Disabilities Estate | Dashboard</title>
    
    <link rel="icon" href="https://assets.hse.ie/static/hse-frontend/assets/favicons/favicon.ico">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet for Mapping -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <!-- Turf.js for Spatial Analysis -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- SheetJS for Excel Parsing -->
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif; 
            -webkit-font-smoothing: antialiased;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: #1e293b;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --hse-primary: #006858;
            --hse-secondary: #00bfa5;
            --hse-dark: #004d42;
        }

        .hse-gradient {
            background: linear-gradient(135deg, #004d42 0%, #006858 50%, #00917a 100%);
            position: relative;
            overflow: hidden;
        }

        .hse-gradient::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.4;
        }

        .app-card {
            background: linear-gradient(to bottom, #ffffff, #fefefe);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            border-radius: 1rem;
            overflow: hidden;
        }

        /* Premium Glass Effect */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { 
            background: #cbd5e1; 
            border-radius: 4px; 
        }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 10;
        }

        .custom-div-icon {
            background: transparent;
            border: none;
        }

        .marker-pin {
            width: 36px;
            height: 36px;
            border-radius: 50% 50% 50% 0;
            background: var(--hse-primary);
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -18px 0 0 -18px;
            box-shadow: -2px 2px 6px rgba(0,0,0,0.4);
            transition: background 0.3s ease;
        }

        .marker-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 22px !important;
            height: 22px !important;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        /* Status Colours */
        .marker-hse { background: #006858; } /* Primary */
        .marker-sec38 { background: #ea580c; } /* Orange */
        .marker-sec39 { background: #eab308; } /* Yellow */
        .marker-leased { background: #f59e0b; } /* Amber */
        .marker-hserun { background: #ec4899; } /* Pink */

        /* Region Colours */
        .marker-region-midlands { background: #9f1239; } 
        .marker-region-northeast { background: #ea580c; } 
        .marker-region-southeast { background: #0f766e; } 
        .marker-region-midwest { background: #3730a3; } 
        .marker-region-southwest { background: #006858; } 
        .marker-region-west { background: #eab308; } 
        .marker-default { background: #64748b; }

        /* Custom HSE Cluster Styling */
        .marker-cluster-custom {
            background-clip: padding-box;
            border-radius: 20px;
            background-color: rgba(0, 191, 165, 0.4);
        }
        .marker-cluster-custom div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font-family: 'Inter', system-ui, sans-serif;
            font-size: 12px;
            font-weight: 800;
            color: #ffffff;
            background-color: #006858;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        
        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 0 5px rgba(16, 185, 129, 0.5); }
            50% { box-shadow: 0 0 15px rgba(16, 185, 129, 0.8); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Safe Icon Component ---
        const Icon = ({ name, size = 18, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && window.lucide) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}"></i>`;
                    window.lucide.createIcons({ root: containerRef.current });
                    const svg = containerRef.current.querySelector('svg');
                    if (svg) {
                        svg.setAttribute('width', size);
                        svg.setAttribute('height', size);
                        if (className) svg.setAttribute('class', `lucide lucide-${name} ${className}`);
                    }
                }
            }, [name, size, className]);

            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        // --- Main Application ---
        function App() {
            const [properties, setProperties] = useState([]);
            const [selectedType, setSelectedType] = useState("All");
            const [selectedRegion, setSelectedRegion] = useState("All");
            const [searchQuery, setSearchQuery] = useState("");
            
            // Map controls
            const [showIsochrones, setShowIsochrones] = useState(false);
            const [useClustering, setUseClustering] = useState(true);
            const [colorMode, setColorMode] = useState("Status"); // "Status" or "Region"
            const [selectedProperty, setSelectedProperty] = useState(null);
            
            // Settings
            const [mapboxApiKey, setMapboxApiKey] = useState("");
            const [showSettings, setShowSettings] = useState(false);
            const [tempApiKey, setTempApiKey] = useState("");
            
            // Isochrone & Population Insights
            const [isoIntervals, setIsoIntervals] = useState([15, 30]);
            const [tempIsoIntervals, setTempIsoIntervals] = useState([15, 30]);
            const [zoneInsights, setZoneInsights] = useState(null);
            const [isCalculatingInsights, setIsCalculatingInsights] = useState(false);

            const mapRef = useRef(null);
            const mapInstance = useRef(null);
            const markersLayer = useRef(null);
            const isochroneLayer = useRef(null);

            // Load API key on mount
            useEffect(() => {
                const savedKey = localStorage.getItem("hseMapboxKey");
                if (savedKey) {
                    setMapboxApiKey(savedKey);
                    setTempApiKey(savedKey);
                }
                const savedIntervals = localStorage.getItem("hseIsoIntervals");
                if (savedIntervals) {
                    const parsed = JSON.parse(savedIntervals);
                    setIsoIntervals(parsed);
                    setTempIsoIntervals(parsed);
                }
            }, []);

            const handleSaveSettings = () => {
                setMapboxApiKey(tempApiKey);
                localStorage.setItem("hseMapboxKey", tempApiKey);
                
                setIsoIntervals(tempIsoIntervals);
                localStorage.setItem("hseIsoIntervals", JSON.stringify(tempIsoIntervals));
                
                setShowSettings(false);
                // Redraw isochrones if active
                if (showIsochrones && selectedProperty) {
                    // Need a slight timeout to ensure state update applies before redrawing
                    setTimeout(() => drawIsochrones(selectedProperty, tempIsoIntervals), 50);
                }
            };

            // Dynamically generate property types
            const propertyTypes = useMemo(() => {
                const types = new Set(properties.map(p => p.type));
                return ["All", ...Array.from(types).filter(Boolean).sort()];
            }, [properties]);

            // Dynamically generate HSE Health Regions
            const regionsList = useMemo(() => {
                const regions = new Set(properties.map(p => p.region));
                return ["All", ...Array.from(regions).filter(Boolean).sort()];
            }, [properties]);

            // Calculate Stats
            const stats = useMemo(() => {
                let filtered = properties;
                
                if (selectedType !== "All") {
                    filtered = filtered.filter(p => p.type === selectedType);
                }
                if (selectedRegion !== "All") {
                    filtered = filtered.filter(p => p.region === selectedRegion);
                }
                if (searchQuery.trim() !== "") {
                    const q = searchQuery.toLowerCase();
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(q) || 
                        p.buildings.some(b => b.name.toLowerCase().includes(q))
                    );
                }
                
                const totalBeds = filtered.reduce((sum, p) => sum + (Number(p.totalBeds) || 0), 0);
                const totalBuildings = filtered.reduce((sum, p) => sum + (p.buildings ? p.buildings.length : 0), 0);
                
                const compliant = filtered.filter(p => p.slaStatus === "Compliant").length;
                const withSLA = filtered.filter(p => p.slaStatus === "Compliant" || p.slaStatus === "Non-Compliant").length;
                const slaPercent = withSLA > 0 ? Math.round((compliant / withSLA) * 100) : 0;

                return { 
                    totalSites: filtered.length, 
                    totalBuildings: totalBuildings, 
                    beds: totalBeds, 
                    slaCompliance: slaPercent, 
                    withSLA: withSLA,
                    filtered 
                };
            }, [properties, selectedType, selectedRegion, searchQuery]);

            // Initialize Map
            useEffect(() => {
                if (!mapInstance.current && mapRef.current) {
                    mapInstance.current = L.map(mapRef.current).setView([53.3498, -8.0], 7);
                    
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    }).addTo(mapInstance.current);

                    isochroneLayer.current = L.layerGroup().addTo(mapInstance.current);
                }
            }, []);

            // Update Map Markers
            useEffect(() => {
                if (!mapInstance.current) return;
                
                if (markersLayer.current) {
                    mapInstance.current.removeLayer(markersLayer.current);
                }

                if (useClustering) {
                    markersLayer.current = L.markerClusterGroup({
                        showCoverageOnHover: false,
                        maxClusterRadius: 40,
                        iconCreateFunction: function(cluster) {
                            return L.divIcon({ 
                                html: '<div><span>' + cluster.getChildCount() + '</span></div>', 
                                className: 'marker-cluster-custom', 
                                iconSize: L.point(40, 40) 
                            });
                        }
                    });
                } else {
                    markersLayer.current = L.layerGroup();
                }

                mapInstance.current.addLayer(markersLayer.current);
                
                stats.filtered.forEach(prop => {
                    if (!prop.lat || !prop.lng) return;

                    let markerColorClass = "marker-default";

                    if (colorMode === "Status") {
                        const typeLower = (prop.type || "").toLowerCase();
                        if (typeLower.includes("facility") || typeLower.includes("hse owned")) markerColorClass = "marker-hse";
                        else if (typeLower.includes("section 38")) markerColorClass = "marker-sec38";
                        else if (typeLower.includes("section 39")) markerColorClass = "marker-sec39";
                        else if (typeLower.includes("leased")) markerColorClass = "marker-leased";
                        else if (typeLower.includes("run")) markerColorClass = "marker-hserun";
                        else markerColorClass = "marker-hse";
                    } else {
                        const regionLower = (prop.region || "").toLowerCase();
                        if (regionLower.includes("midlands")) markerColorClass = "marker-region-midlands";
                        else if (regionLower.includes("north east")) markerColorClass = "marker-region-northeast";
                        else if (regionLower.includes("south east")) markerColorClass = "marker-region-southeast";
                        else if (regionLower.includes("mid west")) markerColorClass = "marker-region-midwest";
                        else if (regionLower.includes("south west")) markerColorClass = "marker-region-southwest";
                        else if (regionLower.includes("north west")) markerColorClass = "marker-region-west";
                    }

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class='marker-pin ${markerColorClass}'><img src="https://www.esther.ie/wp-content/uploads/2022/05/HSE-Logo-Green-NEW-no-background.png" class="marker-icon" alt="HSE" width="22" height="22" /></div>`,
                        iconSize: [36, 42],
                        iconAnchor: [18, 42]
                    });

                    const buildingsListHtml = prop.buildings.map(b => 
                        `<li class="mb-1 border-b border-slate-200 pb-1 last:border-0 last:pb-0">
                            <span class="font-bold text-slate-700">${b.name}</span><br/>
                            <span class="text-[10px] text-slate-500">${b.pillar || b.use} ${b.beds > 0 ? `| <b class="text-[#006858]">${b.beds} Beds</b>` : ''}</span>
                        </li>`
                    ).join('');

                    const marker = L.marker([prop.lat, prop.lng], { icon })
                        .bindPopup(`
                            <div class="font-sans max-w-[250px] max-h-[250px] overflow-y-auto">
                                <strong class="text-sm text-[#006858] block mb-1 leading-tight">${prop.name}</strong>
                                <span class="text-[10px] uppercase tracking-wider font-bold text-slate-500 block">${prop.type}</span>
                                <span class="text-[9px] uppercase font-bold text-slate-400 block mb-2">${prop.region}</span>
                                <div class="bg-slate-50 p-2 rounded border border-slate-100 mb-2">
                                    <span class="text-xs font-bold text-[#00bfa5] block mb-1">${prop.buildings.length} Building(s) on Site</span>
                                    <ul class="text-xs">
                                        ${buildingsListHtml}
                                    </ul>
                                </div>
                                ${prop.totalBeds > 0 ? `<div class="text-xs bg-emerald-50 text-[#006858] p-1.5 rounded font-bold border border-emerald-100">Total Site Beds: ${prop.totalBeds}</div>` : ''}
                            </div>
                        `);

                    marker.on('click', () => {
                        setSelectedProperty(prop);
                        if (showIsochrones) drawIsochrones(prop);
                    });

                    marker.addTo(markersLayer.current);
                });

                if (showIsochrones && selectedProperty) {
                    drawIsochrones(selectedProperty);
                } else {
                    isochroneLayer.current.clearLayers();
                }

            }, [stats.filtered, showIsochrones, colorMode, useClustering]);

            // Mapbox Isochrone & OpenStreetMap Population Logic
            const drawIsochrones = async (prop, overrideIntervals = null) => {
                if (!isochroneLayer.current) return;
                isochroneLayer.current.clearLayers();
                setZoneInsights(null);

                const activeIntervals = overrideIntervals || isoIntervals;
                if (activeIntervals.length === 0) return;

                const sortedIntervals = [...activeIntervals].sort((a, b) => a - b);
                let apiSuccess = false;
                let mapboxData = null;

                // Dynamic Styling Logic based on number of active layers
                const getStyle = (contourValue) => {
                    const index = sortedIntervals.indexOf(contourValue);
                    const count = sortedIntervals.length;

                    if (count === 3) {
                        if (index === 0) return { color: '#00bfa5', fillColor: '#00bfa5', fillOpacity: 0.3, weight: 2 }; // Light Green
                        if (index === 1) return { color: '#006858', fillColor: '#006858', fillOpacity: 0.15, weight: 2 }; // Dark Green
                        if (index === 2) return { color: '#9f1239', fillColor: '#9f1239', fillOpacity: 0.1, weight: 2, dashArray: '4' }; // Wine
                    } else if (count === 2) {
                        if (index === 0) return { color: '#00bfa5', fillColor: '#00bfa5', fillOpacity: 0.3, weight: 2 }; // Light Green
                        if (index === 1) return { color: '#9f1239', fillColor: '#9f1239', fillOpacity: 0.1, weight: 2, dashArray: '4' }; // Wine
                    } else {
                        return { color: '#00bfa5', fillColor: '#00bfa5', fillOpacity: 0.3, weight: 2 }; // Light Green default
                    }
                };

                if (mapboxApiKey) {
                    try {
                        const url = `https://api.mapbox.com/isochrone/v1/mapbox/driving/${prop.lng},${prop.lat}?contours_minutes=${sortedIntervals.join(',')}&polygons=true&access_token=${mapboxApiKey}`;
                        const response = await fetch(url);
                        
                        if (response.ok) {
                            mapboxData = await response.json();
                            
                            L.geoJSON(mapboxData, {
                                style: function(feature) {
                                    return getStyle(feature.properties.contour);
                                }
                            }).addTo(isochroneLayer.current);
                            
                            apiSuccess = true;
                        } else {
                            console.warn("Mapbox API issue, falling back to radii.");
                        }
                    } catch (error) {
                        console.error("Isochrone fetch failed:", error);
                    }
                }

                if (!apiSuccess) {
                    const radiusMap = { 15: 10000, 30: 25000, 60: 55000 }; 
                    [...sortedIntervals].reverse().forEach(contourValue => {
                        const style = getStyle(contourValue);
                        const radius = radiusMap[contourValue] || (contourValue * 800); 
                        
                        L.circle([prop.lat, prop.lng], {
                            color: style.color, 
                            fillColor: style.fillColor, 
                            fillOpacity: style.fillOpacity, 
                            weight: style.weight,
                            dashArray: style.dashArray || ''
                        }).addTo(isochroneLayer.current).bindPopup(`Approx ${contourValue}-min travel radius (Fallback)`);
                    });
                }
                
                mapInstance.current.setView([prop.lat, prop.lng], 10);

                // --- Catchment Population Calculation via Free OSM API ---
                setIsCalculatingInsights(true);
                try {
                    const maxTime = Math.max(...sortedIntervals);
                    const maxRadius = maxTime === 15 ? 15000 : maxTime === 30 ? 30000 : 60000; 
                    
                    const overpassQuery = `[out:json];(node["place"~"city|town|village"]["population"](around:${maxRadius},${prop.lat},${prop.lng}););out body;`;
                    const overpassUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(overpassQuery)}`;
                    
                    const opRes = await fetch(overpassUrl);
                    if (opRes.ok) {
                        const opData = await opRes.json();
                        const popByZone = {};
                        sortedIntervals.forEach(min => popByZone[min] = 0);
                        
                        opData.elements.forEach(el => {
                            const popStr = el.tags.population ? el.tags.population.replace(/,/g, '') : "0";
                            const pop = parseInt(popStr, 10);
                            
                            if (pop > 0 && window.turf) {
                                const pt = window.turf.point([el.lon, el.lat]);
                                let assignedZone = null;
                                
                                if (mapboxData) {
                                    // Check if town is inside the Mapbox polygons
                                    for (const min of sortedIntervals) {
                                        const feature = mapboxData.features.find(f => f.properties.contour === min);
                                        if (feature && feature.geometry && window.turf.booleanPointInPolygon(pt, feature)) {
                                            assignedZone = min;
                                            break;
                                        }
                                    }
                                } else {
                                    // Check if town is inside fallback circles
                                    const dist = window.turf.distance(window.turf.point([prop.lng, prop.lat]), pt, {units: 'meters'});
                                    for (const min of sortedIntervals) {
                                        const r = min === 15 ? 10000 : min === 30 ? 25000 : 55000;
                                        if (dist <= r) {
                                            assignedZone = min;
                                            break;
                                        }
                                    }
                                }
                                
                                // Cumulative Population (if in 15m, it's also in 30m)
                                if (assignedZone) {
                                    sortedIntervals.forEach(min => {
                                        if (min >= assignedZone) popByZone[min] += pop;
                                    });
                                }
                            }
                        });
                        
                        setZoneInsights({ popByZone });
                    }
                } catch (e) {
                    console.error("Population fetch failed:", e);
                } finally {
                    setIsCalculatingInsights(false);
                }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, {type:'binary'});
                        const wsname = wb.SheetNames[0];
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wsname]);
                        
                        const grouped = data.reduce((acc, row) => {
                            const rawParent = row['Parent Property'] || row['Address'] || row['Building'] || `UPLOAD-SITE-${Math.random()}`;
                            const parentKey = rawParent.toString().trim();
                            
                            if (!acc[parentKey]) {
                                acc[parentKey] = {
                                    id: parentKey,
                                    name: parentKey,
                                    type: (row['Location Status'] || row['Ownership'] || row['Type'] || 'HSE Facility').toString().trim(),
                                    region: (row['HSE Health Region'] || row['Region'] || 'Unknown Region').toString().trim(),
                                    slaStatus: row['SLA'] || row['Status'] || row['Compliance'] || 'Review Required',
                                    county: row['County'] || '',
                                    address: row['Address'] || '',
                                    eircode: row['Eircode'] || '',
                                    lat: parseFloat(row['GIS Latitude'] || row['Lat'] || row['Latitude'] || 53.0 + (Math.random() - 0.5)),
                                    lng: parseFloat(row['GIS Longitude'] || row['Lng'] || row['Longitude'] || -8.0 + (Math.random() - 0.5)),
                                    buildings: [],
                                    totalBeds: 0
                                };
                            }
                            
                            const beds = parseInt(row['Beds'] || row['Capacity'] || 0);
                            acc[parentKey].buildings.push({
                                buildingId: row['Building ID'] || row['ID'] || `ID-${Math.random().toString().substr(2,5)}`,
                                name: row['Building'] || row['Name'] || row['Facility'] || 'Unnamed Building',
                                use: row['Primary Use'] || '',
                                pillar: row['Pillar'] || '',
                                beds: beds
                            });
                            
                            acc[parentKey].totalBeds += beds;
                            return acc;
                        }, {});

                        setProperties(Object.values(grouped));
                        setSelectedType("All"); 
                        setSelectedRegion("All");
                        setSearchQuery("");
                    } catch (err) {
                        console.error(err);
                        alert("Error parsing Excel file. Ensure columns roughly match expected format.");
                    }
                };
                reader.readAsBinaryString(file);
            };

            return (
                <div className="min-h-screen flex flex-col bg-slate-50 relative">
                    
                    {/* Settings Modal Layer */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-slate-900/60 z-[1000] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-xl font-black text-slate-800 flex items-center gap-2"><Icon name="map" /> Map API Settings</h3>
                                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-slate-600"><Icon name="x" size={20}/></button>
                                </div>
                                <p className="text-sm text-slate-500 mb-4 font-medium leading-relaxed">
                                    Configure your mapbox key and select the travel zones you want to generate when clicking a property.
                                </p>
                                
                                <div className="mb-4">
                                    <label className="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Travel Zones</label>
                                    <div className="flex gap-4 p-3 bg-slate-50 rounded-lg border border-slate-200">
                                        {[15, 30, 60].map(min => (
                                            <label key={min} className="flex items-center gap-2 text-sm text-slate-700 font-semibold cursor-pointer">
                                                <input 
                                                    type="checkbox" 
                                                    checked={tempIsoIntervals.includes(min)}
                                                    onChange={() => {
                                                        setTempIsoIntervals(prev => {
                                                            if (prev.includes(min)) {
                                                                if (prev.length === 1) return prev; // prevent emptying
                                                                return prev.filter(v => v !== min);
                                                            }
                                                            return [...prev, min].sort((a,b)=>a-b);
                                                        });
                                                    }}
                                                    className="w-4 h-4 rounded text-[#006858] focus:ring-[#006858] border-slate-300"
                                                />
                                                {min === 60 ? '1 Hour' : `${min} Mins`}
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                <div className="mb-6">
                                    <label className="block text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2">Mapbox API Key</label>
                                    <input 
                                        type="text" 
                                        value={tempApiKey}
                                        onChange={(e) => setTempApiKey(e.target.value)}
                                        placeholder="pk.eyJ1Ijoi..."
                                        className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:ring-[#006858] focus:border-[#006858]"
                                    />
                                </div>
                                <div className="flex justify-end gap-3">
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg font-bold text-sm transition-colors">Cancel</button>
                                    <button onClick={handleSaveSettings} className="px-4 py-2 bg-[#006858] hover:bg-[#004d42] text-white rounded-lg font-bold text-sm transition-colors shadow-lg">Save Settings</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <header className="hse-gradient text-white pt-8 pb-16 px-6 relative shadow-xl z-20">
                        <div className="max-w-[1400px] mx-auto relative z-10">
                            <nav className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                                <div className="flex items-center gap-5">
                                    <div className="bg-white p-2.5 rounded-xl shadow-lg">
                                        <img src="https://www.esther.ie/wp-content/uploads/2022/05/HSE-Logo-Green-NEW-no-background.png" alt="HSE Logo" className="h-10"/>
                                    </div>
                                    <div className="border-l-2 border-white/30 pl-4">
                                        <h1 className="text-2xl font-black tracking-tight">HSE Capital & Estates</h1>
                                        <p className="text-xs text-emerald-100 font-bold uppercase tracking-widest">Disabilities Estate Dashboard</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <label className="cursor-pointer bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur-sm px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg transition-all flex items-center gap-2">
                                        <Icon name="upload-cloud" size={18} />
                                        Upload Excel Data
                                        <input type="file" accept=".xlsx, .xls, .csv" className="hidden" onChange={handleFileUpload} />
                                    </label>
                                </div>
                            </nav>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-[1400px] mx-auto px-6 -mt-10 flex-1 w-full relative z-30 flex flex-col gap-6">
                        
                        {/* Stats Row */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 animate-fade-in">
                            <div className="app-card p-5 border-l-4 border-l-[#006858]">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Total Sites</p>
                                        <h3 className="text-3xl font-black text-slate-800">{stats.totalSites}</h3>
                                        <p className="text-xs font-semibold text-emerald-600 mt-1">{stats.totalBuildings} Individual Buildings</p>
                                    </div>
                                    <div className="p-2 bg-emerald-50 rounded-lg text-[#006858]"><Icon name="map-pin" size={24}/></div>
                                </div>
                            </div>
                            <div className="app-card p-5 border-l-4 border-l-[#00bfa5]">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Total Bed Capacity</p>
                                        <h3 className="text-3xl font-black text-slate-800">{stats.beds}</h3>
                                        <p className="text-xs font-semibold text-slate-400 mt-1">Across all filtered sites</p>
                                    </div>
                                    <div className="p-2 bg-emerald-50 rounded-lg text-[#00bfa5]"><Icon name="bed" size={24}/></div>
                                </div>
                            </div>
                            <div className="app-card p-5 border-l-4 border-l-blue-500">
                                <div className="flex justify-between items-start">
                                    <div>
                                        <p className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">SLA Compliance</p>
                                        <h3 className="text-3xl font-black text-slate-800">{stats.withSLA > 0 ? `${stats.slaCompliance}%` : 'N/A'}</h3>
                                        <p className="text-xs font-semibold text-slate-400 mt-1">{stats.withSLA > 0 ? 'Of assessed sites' : 'Pending Review'}</p>
                                    </div>
                                    <div className="p-2 bg-blue-50 rounded-lg text-blue-500"><Icon name="clipboard-check" size={24}/></div>
                                </div>
                            </div>
                            <div className="app-card p-4 glass-panel flex flex-col justify-center gap-3">
                                <div>
                                    <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Location Status Filter</p>
                                    <select 
                                        className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-xs rounded-lg focus:ring-[#006858] focus:border-[#006858] block p-1.5 font-medium"
                                        value={selectedType}
                                        onChange={(e) => setSelectedType(e.target.value)}
                                    >
                                        {propertyTypes.map(t => (
                                            <option key={t} value={t}>{t === 'All' ? 'All Statuses' : t}</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <p className="text-[10px] font-bold text-slate-500 uppercase tracking-wider mb-1">Health Region Filter</p>
                                    <select 
                                        className="w-full bg-slate-50 border border-slate-200 text-slate-800 text-xs rounded-lg focus:ring-[#006858] focus:border-[#006858] block p-1.5 font-medium"
                                        value={selectedRegion}
                                        onChange={(e) => setSelectedRegion(e.target.value)}
                                    >
                                        {regionsList.map(a => (
                                            <option key={a} value={a}>{a === 'All' ? 'All Regions' : a}</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                        </div>

                        {/* Map and Table Area */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px] mb-12">
                            
                            {/* Map Container */}
                            <div className="lg:col-span-2 app-card relative flex flex-col">
                                
                                {/* Map Controls */}
                                <div className="absolute top-4 right-4 z-[400] flex flex-col gap-2">
                                    <div className="bg-white p-1 rounded-lg shadow-md border border-slate-200 flex mb-2">
                                        <button 
                                            onClick={() => setColorMode("Status")}
                                            className={`px-3 py-1.5 text-xs font-bold rounded flex-1 transition-all ${colorMode === "Status" ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}
                                        >
                                            Colour: Status
                                        </button>
                                        <button 
                                            onClick={() => setColorMode("Region")}
                                            className={`px-3 py-1.5 text-xs font-bold rounded flex-1 transition-all ${colorMode === "Region" ? 'bg-slate-800 text-white' : 'text-slate-500 hover:bg-slate-100'}`}
                                        >
                                            Colour: Region
                                        </button>
                                    </div>
                                    <button 
                                        onClick={() => setUseClustering(!useClustering)}
                                        className={`px-3 py-2 rounded-lg shadow-md text-xs font-bold flex items-center gap-2 transition-all ${useClustering ? 'bg-[#006858] text-white' : 'bg-white text-slate-600 hover:bg-slate-50'}`}
                                    >
                                        <Icon name="layers" size={14} />
                                        Clustering: {useClustering ? "ON" : "OFF"}
                                    </button>
                                    
                                    <div className="flex items-center gap-1">
                                        <button 
                                            onClick={() => setShowIsochrones(!showIsochrones)}
                                            className={`flex-1 px-3 py-2 rounded-lg shadow-md text-xs font-bold flex items-center justify-center gap-2 transition-all ${showIsochrones ? 'bg-[#006858] text-white' : 'bg-white text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            <Icon name="radar" size={14} />
                                            Travel Zones
                                        </button>
                                        <button 
                                            onClick={() => setShowSettings(true)}
                                            className="px-2.5 py-2 rounded-lg shadow-md bg-white text-slate-500 hover:text-slate-800 transition-all border border-transparent hover:border-slate-200"
                                            title="Map Settings & API Keys"
                                        >
                                            <Icon name="settings" size={14} />
                                        </button>
                                    </div>
                                </div>

                                {/* Population Insights Panel */}
                                {showIsochrones && selectedProperty && (
                                    <div className="absolute top-4 left-4 z-[400] bg-white/95 backdrop-blur-md p-4 rounded-xl shadow-xl border border-slate-200 w-64 animate-fade-in">
                                        <h4 className="font-black text-[#004d42] text-sm mb-1 leading-tight">{selectedProperty.name}</h4>
                                        <p className="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 border-b border-slate-100 pb-2">Catchment Population</p>
                                        
                                        {isCalculatingInsights ? (
                                            <div className="flex flex-col items-center justify-center py-5 text-slate-400 gap-3">
                                                <Icon name="loader-2" className="animate-spin text-[#00bfa5]" size={28} />
                                                <span className="text-[10px] font-bold uppercase tracking-wider">Querying Spatial API...</span>
                                            </div>
                                        ) : zoneInsights ? (
                                            <div className="flex flex-col gap-2">
                                                {isoIntervals.sort((a,b)=>a-b).map((min, index) => (
                                                    <div key={min} className="flex justify-between items-center bg-slate-50 p-2.5 rounded-lg border border-slate-100 shadow-sm">
                                                        <span className="text-xs font-bold text-slate-600 flex items-center gap-1.5">
                                                            <Icon name="car" size={12} className={index === 0 ? "text-[#00bfa5]" : index === 1 && isoIntervals.length > 2 ? "text-[#006858]" : "text-[#9f1239]"} />
                                                            {min === 60 ? '1 Hour' : `${min} Mins`}
                                                        </span>
                                                        <span className="text-sm font-black text-slate-800">
                                                            {zoneInsights.popByZone[min].toLocaleString()}
                                                        </span>
                                                    </div>
                                                ))}
                                                <p className="text-[9px] text-slate-400 font-medium leading-tight mt-2 text-center bg-slate-50 p-1.5 rounded">
                                                    Estimates calculated via Turf.js spatial analysis of OSM town census data. Excludes dispersed rural dwellings.
                                                </p>
                                            </div>
                                        ) : (
                                            <p className="text-xs text-slate-500 text-center py-2 font-medium">Population data unavailable.</p>
                                        )}
                                    </div>
                                )}

                                {/* Dynamic Legend */}
                                <div className="absolute bottom-6 left-4 z-[400] bg-white/95 backdrop-blur-sm p-3 rounded-lg shadow-lg border border-slate-200 text-[10px] font-bold flex flex-col gap-1.5 pointer-events-none">
                                    <p className="text-slate-500 mb-1 border-b border-slate-100 pb-1 uppercase tracking-widest">{colorMode === 'Region' ? 'Health Regions' : 'Location Status'}</p>
                                    {colorMode === 'Region' ? (
                                        <>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#9f1239]"></span> Dublin & Midlands</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#ea580c]"></span> Dublin & North East</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#0f766e]"></span> Dublin & South East</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#3730a3]"></span> Mid West</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#006858]"></span> South West</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#eab308]"></span> West & North West</div>
                                        </>
                                    ) : (
                                        <>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#006858]"></span> HSE Facility</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#ea580c]"></span> Section 38 Owned</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#eab308]"></span> Section 39 Owned</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#f59e0b]"></span> Leased</div>
                                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#ec4899]"></span> Sec 38/39 Run</div>
                                        </>
                                    )}
                                </div>
                                
                                <div id="map" ref={mapRef} className="flex-1 w-full bg-slate-200"></div>
                            </div>

                            {/* Data Table Container */}
                            <div className="app-card flex flex-col bg-white overflow-hidden">
                                <div className="p-4 border-b border-slate-100 bg-slate-50 flex flex-col gap-3">
                                    <div className="flex justify-between items-center">
                                        <h3 className="font-bold text-slate-800">Property Directory</h3>
                                        <span className="text-xs bg-slate-200 text-slate-600 px-2 py-1 rounded font-bold">{stats.filtered.length} Sites</span>
                                    </div>
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 flex items-center pl-2.5 pointer-events-none text-slate-400">
                                            <Icon name="search" size={14} />
                                        </div>
                                        <input 
                                            type="text" 
                                            className="w-full bg-white border border-slate-200 text-slate-800 text-xs rounded-lg pl-8 p-2 focus:ring-[#006858] focus:border-[#006858]" 
                                            placeholder="Search sites or buildings..."
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                        />
                                    </div>
                                </div>
                                <div className="overflow-y-auto flex-1 p-2">
                                    {stats.filtered.length === 0 ? (
                                        <div className="text-center py-10 text-slate-400 flex flex-col items-center">
                                            <Icon name="folder-search" size={32} className="mb-2 opacity-50"/>
                                            <p className="text-sm font-semibold">Ready to begin</p>
                                            <p className="text-xs mt-1">Please upload your HSE Excel data.</p>
                                        </div>
                                    ) : (
                                        <div className="flex flex-col gap-2">
                                            {stats.filtered.map(prop => (
                                                <div 
                                                    key={prop.id} 
                                                    onClick={() => {
                                                        setSelectedProperty(prop);
                                                        mapInstance.current.setView([prop.lat, prop.lng], 12);
                                                        if(showIsochrones) drawIsochrones(prop);
                                                    }}
                                                    className={`p-3 rounded-lg border cursor-pointer transition-all hover:shadow-md ${selectedProperty?.id === prop.id ? 'border-[#00bfa5] bg-emerald-50/50' : 'border-slate-100 hover:border-slate-300'}`}
                                                >
                                                    <div className="flex justify-between items-start mb-1">
                                                        <h4 className="font-black text-sm text-[#004d42] leading-tight pr-2">{prop.name}</h4>
                                                        <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-white border border-slate-200 text-[#006858] shrink-0">{prop.buildings.length} Bldgs</span>
                                                    </div>
                                                    <p className="text-[10px] font-semibold uppercase tracking-wider text-slate-500 mb-2">
                                                        <span className="text-[#00bfa5] font-bold">SITE</span>  {prop.type}  {prop.region}
                                                    </p>
                                                    
                                                    {/* Internal Buildings List */}
                                                    <div className="bg-white rounded p-2 text-xs mb-2 border border-slate-100 shadow-sm max-h-32 overflow-y-auto">
                                                        {prop.buildings.map((b, idx) => (
                                                            <div key={b.buildingId || idx} className="flex flex-col border-b border-slate-50 last:border-0 py-1">
                                                                <span className="font-semibold text-slate-700">{b.name}</span>
                                                                <span className="text-[10px] text-slate-400 flex justify-between">
                                                                    <span className="truncate pr-2">{b.use} {b.pillar ? `(${b.pillar})` : ''}</span>
                                                                    {b.beds > 0 && <span className="text-emerald-600 font-bold shrink-0">{b.beds} Beds</span>}
                                                                </span>
                                                            </div>
                                                        ))}
                                                    </div>

                                                    <div className="flex items-center gap-4 text-xs font-medium mt-1">
                                                        {prop.totalBeds > 0 && (
                                                            <div className="flex items-center gap-1 text-slate-600">
                                                                <Icon name="bed" size={12}/> {prop.totalBeds} Total Beds
                                                            </div>
                                                        )}
                                                        <div className={`flex items-center gap-1 ${prop.slaStatus === 'Compliant' ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                            <Icon name={prop.slaStatus === 'Compliant' ? 'check-circle' : 'alert-circle'} size={12}/>
                                                            {prop.slaStatus}
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                    </main>

                    {/* Footer */}
                    <footer className="mt-auto border-t border-slate-300 bg-gradient-to-b from-white to-slate-50 py-10 px-6">
                        <div className="max-w-[1400px] mx-auto flex flex-col md:flex-row justify-between items-center gap-6">
                            <div>
                                <div className="flex items-center gap-3 mb-2">
                                    <div className="w-8 h-8 bg-gradient-to-br from-[#006858] to-[#004d42] rounded-lg flex items-center justify-center shadow-lg">
                                        <img src="https://assets.hse.ie/static/hse-frontend/assets/favicons/favicon.ico" className="w-5 h-5 brightness-0 invert" alt=""/>
                                    </div>
                                    <span className="font-black text-slate-900 text-lg">HSE Capital & Estates</span>
                                </div>
                                <p className="text-xs text-slate-500 font-medium">&copy; 2026 Health Service Executive. All rights reserved.</p>
                            </div>

                            <div className="text-center md:text-right">
                                <p className="text-sm font-black text-slate-800">Digital Solutions Developed by Dave Maher</p>
                                <p className="text-xs text-slate-500 mt-1 uppercase tracking-widest font-bold">HSE Estates Infrastructure Intelligence</p>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
