<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HSE Resource Booking</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (Pinned to stable version) -->
    <script src="https://unpkg.com/@babel/standalone@7.23.8/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- HSE Styling -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .bg-hse-primary { background-color: #006858; }
        .text-hse-primary { color: #006858; }
        .border-hse-primary { border-color: #006858; }
        .hover-bg-hse-dark:hover { background-color: #005548; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- UPDATED: Removed 'env' from presets to stop 'require is not defined' error -->
    <script type="text/babel" data-type="module" data-presets="react">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyA5V4lsX8yk8y9e6XmSDHzKrOn8xJS44Uo",
          authDomain: "bookingapp-7195d.firebaseapp.com",
          projectId: "bookingapp-7195d",
          storageBucket: "bookingapp-7195d.firebasestorage.app",
          messagingSenderId: "215430202115",
          appId: "1:215430202115:web:2ef23530555c928d7a9f36",
          measurementId: "G-SB6NB7JWKB"
        };

        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            signInAnonymously(auth).catch(console.error);
        } catch (e) {
            console.error("Firebase Init Error", e);
        }
        
        const appId = 'hse-estates-main'; 
        const { useState, useEffect, useMemo } = React;

        // --- UTILS ---
        const Icon = ({ name, size = 18, className }) => <i data-lucide={name} width={size} height={size} className={className}></i>;
        const formatTime = (d) => d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const formatDate = (d) => d.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'long', year: 'numeric' });
        const getHoursArray = () => Array.from({length: 11}, (_, i) => i + 8); 
        const isOverlapping = (sA, eA, sB, eB) => sA < eB && eA > sB;

        const getRelativeTime = (date) => {
            const diff = date - new Date();
            if (diff <= 0) return 'now';
            const mins = Math.floor(diff / 60000);
            const hrs = Math.floor(mins / 60);
            const days = Math.floor(hrs / 24);
            if (mins < 60) return `in ${mins} mins`;
            if (hrs < 24) return `in ${hrs} hrs ${mins % 60} mins`;
            return `in ${days} day${days !== 1 ? 's' : ''}`;
        };

        const generateICS = (b, roomName) => {
            const fmt = (d) => d.toISOString().replace(/-|:|\.\d+/g, "");
            const content = `BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${fmt(b.start)}\nDTEND:${fmt(b.end)}\nSUMMARY:${b.title}\nDESCRIPTION:Organiser: ${b.organiser}\nLOCATION:${roomName}\nEND:VEVENT\nEND:VCALENDAR`;
            const link = document.createElement('a');
            link.href = window.URL.createObjectURL(new Blob([content], { type: 'text/calendar' }));
            link.setAttribute('download', `${b.title}.ics`);
            link.click();
        };

        const INITIAL_ROOMS = [
            { id: 'mr1', name: 'Meeting Room 01', capacity: 12, amenities: ['Large TV', 'Video Conf', 'Whiteboard'], type: 'Room', floor: '1st Floor', color: 'bg-hse-primary text-white' },
            { id: 'hd1', name: 'Hot Desk 01', capacity: 1, amenities: ['Dual Monitor'], type: 'Desk', floor: 'Ground Floor', color: 'bg-emerald-50 text-hse-primary' },
            { id: 'hd2', name: 'Hot Desk 02', capacity: 1, amenities: ['Dual Monitor'], type: 'Desk', floor: 'Ground Floor', color: 'bg-emerald-50 text-hse-primary' },
            { id: 'hd3', name: 'Hot Desk 03', capacity: 1, amenities: ['Single Monitor'], type: 'Desk', floor: 'Ground Floor', color: 'bg-emerald-50 text-hse-primary' },
            { id: 'hd4', name: 'Hot Desk 04', capacity: 1, amenities: ['Single Monitor'], type: 'Desk', floor: 'Ground Floor', color: 'bg-emerald-50 text-hse-primary' },
            { id: 'hd5', name: 'Hot Desk 05', capacity: 1, amenities: ['Single Monitor'], type: 'Desk', floor: 'Ground Floor', color: 'bg-emerald-50 text-hse-primary' },
        ];

        const getDurationOptions = () => {
            const options = [];
            for(let i = 30; i <= 480; i += 30) {
                const hours = Math.floor(i / 60);
                const mins = i % 60;
                let label = "";
                if(hours > 0) label += `${hours} hr${hours > 1 ? 's' : ''}`;
                if(mins > 0) label += ` ${mins} mins`;
                options.push({ value: i.toString(), label: label.trim() });
            }
            return options;
        };

        // --- SUB-COMPONENTS ---
        const NavLink = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-bold transition-all ${active ? 'bg-emerald-50 text-hse-primary border-r-4 border-hse-primary' : 'text-slate-600 hover:bg-slate-50'}`}>
                <Icon name={icon} size={18} /> {label}
            </button>
        );

        const MobileNavLink = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center py-2 flex-1 transition-all ${active ? 'text-hse-primary' : 'text-slate-400 hover:text-slate-600'}`}>
                <Icon name={icon} size={24} className={active ? 'scale-110 transition-transform' : ''} />
                <span className="text-[10px] font-bold mt-1">{label}</span>
            </button>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden border-t-4 border-hse-primary animate-in">
                        <div className="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 className="font-bold text-lg text-hse-primary">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><Icon name="x" /></button>
                        </div>
                        <div className="p-6 max-h-[80vh] overflow-y-auto custom-scroll">{children}</div>
                    </div>
                </div>
            );
        };

        const OccupancyHeatmap = ({ bookings, rooms }) => {
            const hours = [8, 10, 12, 14, 16];
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            
            const getSlotData = (dayIndex, hour) => {
                const curr = new Date();
                const first = curr.getDate() - curr.getDay() + 1;
                const date = new Date(curr.setDate(first + dayIndex));
                date.setHours(0,0,0,0);
                const start = new Date(date); start.setHours(hour);
                const end = new Date(date); end.setHours(hour + 2);
                
                const count = bookings.filter(b => isOverlapping(start, end, b.start, b.end)).length;
                const ratio = count / rooms.length;
                let color = 'bg-slate-50 border-slate-100';
                if(ratio > 0) color = ratio < 0.3 ? 'bg-emerald-100' : ratio < 0.6 ? 'bg-[#00bfa5] text-white' : 'bg-hse-primary text-white';
                return { count, color };
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                    <h3 className="font-bold text-slate-800 flex gap-2 mb-4"><Icon name="grid" size={18} className="text-hse-primary" /> Weekly Heatmap</h3>
                    <div className="overflow-x-auto">
                        <div className="min-w-[400px]">
                            <div className="flex mb-2"><div className="w-10"></div>{hours.map(h => <div key={h} className="flex-1 text-center text-xs font-bold text-slate-400">{h}:00</div>)}</div>
                            {days.map((d, i) => (
                                <div key={d} className="flex gap-2 mb-2 items-center h-8">
                                    <div className="w-10 text-xs font-bold text-slate-600">{d}</div>
                                    {hours.map(h => {
                                        const {count, color} = getSlotData(i, h);
                                        return <div key={h} className={`flex-1 h-full rounded border flex items-center justify-center text-xs font-bold ${color}`}>{count > 0 ? count : ''}</div>;
                                    })}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const UtilisationStats = ({ bookings, totalResources }) => {
            const weekBookings = bookings.filter(b => {
                const d = new Date();
                const first = d.getDate() - d.getDay() + 1;
                const start = new Date(d.setDate(first)); start.setHours(0,0,0,0);
                const end = new Date(d.setDate(first + 6)); end.setHours(23,59,59);
                return b.start >= start && b.start <= end;
            });
            const hours = weekBookings.reduce((acc, b) => acc + ((b.end - b.start) / 3600000), 0);
            const util = Math.round((hours / (totalResources * 40)) * 100) || 0;
            
            return (
                <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col justify-between">
                    <div>
                        <h3 className="font-bold text-slate-800 flex gap-2 mb-1"><Icon name="trending-up" size={18} className="text-hse-primary" /> Utilisation</h3>
                        <p className="text-xs text-slate-500 mb-4">Current Week vs Capacity</p>
                    </div>
                    <div>
                        <div className="text-4xl font-bold text-slate-800 mb-2">{util}%</div>
                        <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden">
                            <div className="h-full bg-hse-primary transition-all duration-500" style={{ width: `${Math.min(util, 100)}%` }}></div>
                        </div>
                    </div>
                </div>
            );
        };

        const MeetingRoomWidget = ({ bookings }) => {
            const now = new Date();
            const mrId = 'mr1';
            const current = bookings.find(b => b.roomId === mrId && now >= b.start && now <= b.end);
            const next = bookings.filter(b => b.roomId === mrId && b.start > now).sort((a,b) => a.start - b.start)[0];
            
            return (
                <div className={`p-6 rounded-xl border shadow-sm flex flex-col justify-between ${current ? 'bg-orange-50 border-orange-100' : 'bg-emerald-50 border-emerald-100'}`}>
                    <div>
                        <h3 className={`font-bold text-sm uppercase tracking-wider mb-1 flex items-center gap-2 ${current ? 'text-orange-800' : 'text-emerald-800'}`}><Icon name="presentation" size={16}/> Meeting Room 01</h3>
                        <div className={`text-2xl font-bold ${current ? 'text-orange-600' : 'text-emerald-600'}`}>{current ? 'Occupied' : 'Available'}</div>
                    </div>
                    <div className="mt-4 pt-4 border-t border-black/5 text-sm">
                        {current ? (
                            <div className="text-orange-800 font-bold">Free: {formatTime(current.end)} ({getRelativeTime(current.end)})</div>
                        ) : (
                            <div className="text-emerald-800">
                                {next ? <div><span className="font-bold">Next: {formatTime(next.start)}</span> <span className="text-xs opacity-75">({getRelativeTime(next.start)})</span></div> : <span className="opacity-75">No upcoming meetings</span>}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TopOrganisersChart = ({ bookings }) => {
            const orgs = {};
            bookings.forEach(b => { if(b.organiser) orgs[b.organiser] = (orgs[b.organiser] || 0) + 1; });
            const list = Object.entries(orgs).sort((a,b) => b[1] - a[1]).slice(0, 5);
            return (
                <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm h-full">
                    <h4 className="font-bold text-slate-700 text-sm mb-4 flex items-center gap-2"><Icon name="crown" size={16} className="text-hse-primary"/> Top Organisers</h4>
                    <div className="space-y-3">
                        {list.map(([name, count], i) => (
                            <div key={i} className="flex items-center gap-3">
                                <div className={`w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-bold ${i===0 ? 'bg-yellow-100 text-yellow-700' : 'bg-slate-100'}`}>{i+1}</div>
                                <div className="flex-1 flex justify-between text-xs font-medium text-slate-700"><span>{name}</span><span className="font-bold">{count}</span></div>
                            </div>
                        ))}
                        {list.length === 0 && <p className="text-xs text-slate-400 italic">No data available.</p>}
                    </div>
                </div>
            );
        };

        const ScheduleAnalytics = ({ bookings }) => {
            const now = new Date();
            const weekAheadDaily = [];
            for (let i=0; i<7; i++) {
                const d = new Date(); d.setDate(d.getDate() + i); d.setHours(0,0,0,0);
                const count = bookings.filter(b => {
                    const bDate = new Date(b.start); bDate.setHours(0,0,0,0);
                    return bDate.getTime() === d.getTime();
                }).length;
                weekAheadDaily.push({ day: d.toLocaleDateString('en-GB', {weekday:'short'}), count });
            }
            const total = bookings.length || 1;
            const internal = bookings.filter(b => b.type === 'Internal').length;
            const external = bookings.filter(b => b.type === 'External').length;

            return (
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6 pt-6 border-t border-slate-100">
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 className="font-bold text-slate-700 text-sm mb-4 flex items-center gap-2"><Icon name="pie-chart" size={16} className="text-hse-primary"/> Booking Type Split</h4>
                        <div className="flex h-6 rounded-full overflow-hidden w-full bg-slate-100 mb-2">
                            <div className="bg-hse-primary h-full transition-all" style={{width: `${(internal/total)*100}%`}}></div>
                            <div className="bg-amber-400 h-full transition-all" style={{width: `${(external/total)*100}%`}}></div>
                        </div>
                        <div className="flex justify-between text-xs font-bold">
                            <span className="text-hse-primary flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-hse-primary"></div> {Math.round((internal/total)*100)}% Internal</span>
                            <span className="text-amber-500 flex items-center gap-1"><div className="w-2 h-2 rounded-full bg-amber-400"></div> {Math.round((external/total)*100)}% External</span>
                        </div>
                    </div>
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm">
                        <h4 className="font-bold text-slate-700 text-sm mb-4 flex items-center gap-2"><Icon name="bar-chart-2" size={16} className="text-hse-primary"/> Volume: Next 7 Days</h4>
                        <div className="flex items-end justify-between h-24 gap-2">
                            {weekAheadDaily.map((d, i) => (
                                <div key={i} className="flex-1 flex flex-col items-center gap-1 group">
                                    <div className="w-full bg-emerald-100 rounded-t-sm relative transition-all group-hover:bg-emerald-200" style={{height: `${Math.max((d.count/8)*100, 10)}%`}}>
                                        {d.count > 0 && <span className="absolute -top-4 left-1/2 -translate-x-1/2 text-[9px] font-bold text-hse-primary">{d.count}</span>}
                                    </div>
                                    <span className="text-[9px] font-bold text-slate-400 uppercase">{d.day}</span>
                                </div>
                            ))}
                        </div>
                    </div>
                    <TopOrganisersChart bookings={bookings} />
                </div>
            )
        };

        // --- MAIN APP ---
        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [bookings, setBookings] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isBookingModalOpen, setIsBookingModalOpen] = useState(false);
            const [currentTime, setCurrentTime] = useState(new Date());
            const [notification, setNotification] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [typeFilter, setTypeFilter] = useState('All');
            
            const [newBooking, setNewBooking] = useState({
                title: '', organiser: '', roomId: '',
                date: new Date().toISOString().split('T')[0],
                startTime: '09:00', duration: '60', type: 'Internal', recurrence: 'None', repeatUntil: ''
            });

            // Update Icons on render - Optimized with dependency array
            useEffect(() => { 
                if(window.lucide) window.lucide.createIcons(); 
            }, [activeTab, bookings, isSidebarOpen]);

            // Clock
            useEffect(() => {
                const t = setInterval(() => setCurrentTime(new Date()), 30000);
                return () => clearInterval(t);
            }, []);

            // Firebase Data
            useEffect(() => {
                const unsub = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), 
                    (snap) => {
                        const loaded = snap.docs.map(d => {
                            const data = d.data();
                            return { id: d.id, ...data, start: data.start?.toDate(), end: data.end?.toDate() };
                        });
                        setBookings(loaded);
                        setIsLoading(false);
                    },
                    (err) => { console.error(err); setIsLoading(false); }
                );
                return () => unsub();
            }, []);

            // Notification Auto-Close
            useEffect(() => { if(notification) setTimeout(() => setNotification(null), 3000); }, [notification]);

            // Conflict Logic
            const checkConflict = () => {
                if (!newBooking.roomId || !newBooking.date || !newBooking.startTime) return null;
                const start = new Date(newBooking.date);
                const [h, m] = newBooking.startTime.split(':').map(Number);
                start.setHours(h, m, 0, 0);
                const end = new Date(start.getTime() + parseInt(newBooking.duration) * 60000);
                return bookings.find(b => b.roomId === newBooking.roomId && isOverlapping(start, end, b.start, b.end));
            };
            const conflict = checkConflict();

            const handleCreate = async (e) => {
                e.preventDefault();
                if (conflict) return;
                
                const start = new Date(newBooking.date);
                const [h, m] = newBooking.startTime.split(':').map(Number);
                start.setHours(h, m, 0, 0);
                const end = new Date(start.getTime() + parseInt(newBooking.duration) * 60000);

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'bookings'), {
                        ...newBooking, start: Timestamp.fromDate(start), end: Timestamp.fromDate(end), createdAt: Timestamp.now()
                    });
                    setIsBookingModalOpen(false);
                    setNotification({ type: 'success', message: 'Booking Confirmed' });
                } catch(err) { setNotification({ type: 'error', message: 'Save Failed' }); }
            };

            const handleDelete = async (id) => {
                if(confirm("Cancel booking?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'bookings', id));
                    setNotification({ type: 'success', message: 'Cancelled' });
                }
            };

            // Stats & Filtering
            const filteredRooms = useMemo(() => INITIAL_ROOMS.filter(r => 
                (r.name.toLowerCase().includes(searchQuery.toLowerCase()) || r.amenities.some(a => a.toLowerCase().includes(searchQuery.toLowerCase()))) &&
                (typeFilter === 'All' || r.type === typeFilter)
            ), [searchQuery, typeFilter]);

            const stats = useMemo(() => {
                const today = new Date().toDateString();
                const todays = bookings.filter(b => b.start?.toDateString() === today);
                const active = new Set(todays.map(b => b.roomId)).size;
                const desksUsed = todays.filter(b => INITIAL_ROOMS.find(r => r.id === b.roomId)?.type === 'Desk').length;
                return { 
                    total: todays.length, 
                    util: Math.round((active/INITIAL_ROOMS.length)*100), 
                    desk: desksUsed, 
                    avail: INITIAL_ROOMS.length - active 
                };
            }, [bookings]);

            if (isLoading) return <div className="min-h-screen flex items-center justify-center text-hse-primary font-bold animate-pulse">Loading HSE Estates...</div>;

            return (
                <div className="min-h-screen flex flex-col pb-16 md:pb-0">
                    {/* Header */}
                    <nav className="bg-hse-primary text-white shadow-lg sticky top-0 z-50 px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="hidden md:block p-1 hover:bg-[#005548] rounded"><Icon name="menu" size={24}/></button>
                            <div className="flex items-center gap-3">
                                <div className="bg-white p-1 rounded"><img src="https://www.esther.ie/wp-content/uploads/2022/05/HSE-Logo-Green-NEW-no-background.png" className="h-6" /></div>
                                <div><h1 className="text-lg font-bold leading-none">HSE Capital & Estates</h1><p className="text-[10px] text-emerald-100 uppercase tracking-widest hidden sm:block">Resource Booking</p></div>
                            </div>
                        </div>
                        <div className="hidden md:block text-right">
                            <div className="text-xl font-bold leading-none">{currentTime.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'})}</div>
                            <div className="text-xs text-emerald-100">{currentTime.toLocaleDateString('en-GB')}</div>
                        </div>
                    </nav>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Sidebar */}
                        <aside className={`hidden md:flex flex-col border-r border-slate-200 bg-white transition-all duration-300 ${isSidebarOpen ? 'w-64' : 'w-0 overflow-hidden'}`}>
                            <div className="p-6 space-y-2 min-w-[250px]">
                                <NavLink active={activeTab==='dashboard'} onClick={()=>setActiveTab('dashboard')} icon="bar-chart-3" label="Dashboard" />
                                <NavLink active={activeTab==='schedule'} onClick={()=>setActiveTab('schedule')} icon="calendar" label="Schedule" />
                                <NavLink active={activeTab==='rooms'} onClick={()=>setActiveTab('rooms')} icon="map-pin" label="Directory" />
                            </div>
                        </aside>

                        {/* Content */}
                        <main className="flex-1 overflow-auto bg-slate-50/50 p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-slate-800 capitalize">{activeTab}</h2>
                                <button onClick={() => setIsBookingModalOpen(true)} className="bg-hse-primary text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 shadow-sm hover:bg-hse-dark"><Icon name="plus" /> New Booking</button>
                            </div>

                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-in">
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        {/* UPDATED: LABEL CHANGE */}
                                        <div className="bg-white p-4 rounded shadow-sm border border-slate-200"><p className="text-xs font-bold text-slate-400">TODAY'S BOOKINGS</p><h3 className="text-2xl font-bold">{stats.total}</h3></div>
                                        <div className="bg-white p-4 rounded shadow-sm border border-slate-200"><p className="text-xs font-bold text-slate-400">UTILISATION</p><h3 className="text-2xl font-bold">{stats.util}%</h3></div>
                                        <div className="bg-white p-4 rounded shadow-sm border border-slate-200"><p className="text-xs font-bold text-slate-400">DESKS USED</p><h3 className="text-2xl font-bold">{stats.desk}</h3></div>
                                        <div className="bg-white p-4 rounded shadow-sm border border-slate-200"><p className="text-xs font-bold text-slate-400">AVAILABLE</p><h3 className="text-2xl font-bold">{stats.avail}</h3></div>
                                    </div>
                                    <div className="grid md:grid-cols-3 gap-6">
                                        <div className="md:col-span-2"><OccupancyHeatmap bookings={bookings} rooms={INITIAL_ROOMS} /></div>
                                        <UtilisationStats bookings={bookings} totalResources={INITIAL_ROOMS.length} />
                                    </div>
                                    <div className="grid md:grid-cols-3 gap-6">
                                        <MeetingRoomWidget bookings={bookings} />
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
                                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Icon name="calendar" size={18} className="text-hse-primary" /> Upcoming Schedule</h3>
                                            <div className="space-y-2 flex-1 overflow-y-auto custom-scroll pr-2 max-h-60">
                                                {bookings.filter(b => b.start >= new Date(new Date().setHours(0,0,0,0))).sort((a,b) => a.start - b.start).slice(0, 10).map(b => (
                                                    <div key={b.id} className="flex gap-4 items-center p-2 hover:bg-slate-50 rounded border-b border-slate-50 last:border-0 group">
                                                        <div className="bg-emerald-50 text-hse-primary px-2 py-1 rounded text-xs font-bold min-w-[80px] text-center">
                                                            {formatTime(b.start)}
                                                            <div className="text-[10px] font-normal opacity-75">{new Date(b.start).toLocaleDateString('en-GB', {weekday:'short', day:'numeric', month:'short'})}</div>
                                                        </div>
                                                        <div className="flex-1">
                                                            <div className="font-bold text-sm text-slate-800">{b.title}</div>
                                                            <div className="text-xs text-slate-500">{INITIAL_ROOMS.find(r => r.id === b.roomId)?.name} • {b.organiser}</div>
                                                        </div>
                                                        <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                            <button onClick={() => generateICS(b, INITIAL_ROOMS.find(r => r.id === b.roomId)?.name)} className="p-1 hover:bg-blue-50 text-blue-600 rounded" title="Add to Calendar"><Icon name="calendar-plus" size={16}/></button>
                                                            <button onClick={() => handleDelete(b.id)} className="p-1 hover:bg-red-50 text-red-600 rounded" title="Delete Booking"><Icon name="trash-2" size={16}/></button>
                                                        </div>
                                                    </div>
                                                ))}
                                                {bookings.length === 0 && <p className="text-slate-400 italic text-sm">No upcoming bookings.</p>}
                                            </div>
                                        </div>
                                        <TopOrganisersChart bookings={bookings} />
                                    </div>
                                </div>
                            )}

                            {activeTab === 'schedule' && (
                                <div className="bg-white rounded-xl border border-slate-200 p-4 overflow-auto animate-in flex flex-col gap-6">
                                    <div className="flex justify-between items-center bg-emerald-50 p-2 rounded-lg border border-emerald-100 mb-4">
                                        <button onClick={() => {const d = new Date(selectedDate); d.setDate(d.getDate()-1); setSelectedDate(d)}} className="p-1 hover:bg-emerald-200 text-hse-primary rounded"><Icon name="chevron-left" /></button>
                                        <span className="font-bold text-hse-primary">{formatDate(selectedDate)}</span>
                                        <button onClick={() => {const d = new Date(selectedDate); d.setDate(d.getDate()+1); setSelectedDate(d)}} className="p-1 hover:bg-emerald-200 text-hse-primary rounded"><Icon name="chevron-right" /></button>
                                    </div>
                                    <div className="min-w-[600px]">
                                        {/* UPDATED: DARK GREEN HEADER */}
                                        <div className="grid grid-cols-[150px_1fr] border-b border-[#005548] bg-hse-primary pb-2 pt-2 rounded-t-lg">
                                            <div className="p-2 pl-4 font-bold text-sm text-white">Resource</div>
                                            <div className="grid grid-cols-11">{getHoursArray().map(h => <div key={h} className="text-xs text-center text-emerald-50 font-medium">{h}:00</div>)}</div>
                                        </div>
                                        <div className="divide-y divide-emerald-50">
                                            {filteredRooms.map(r => (
                                                <div key={r.id} className="grid grid-cols-[150px_1fr] py-3 hover:bg-emerald-50 border-b border-slate-50 last:border-0 relative h-16 transition-colors">
                                                    <div className="text-sm font-bold text-hse-primary flex items-center pr-2 border-r border-slate-100 pl-4">{r.name}</div>
                                                    <div className="relative">
                                                        {bookings.filter(b => b.roomId === r.id && b.start?.toDateString() === selectedDate.toDateString()).map(b => {
                                                            const startH = b.start.getHours() + b.start.getMinutes()/60;
                                                            const dur = (b.end - b.start)/3600000;
                                                            return (
                                                                <div key={b.id} className="absolute top-1 bottom-1 rounded bg-hse-primary/10 border border-hse-primary/20 text-hse-primary text-[10px] font-bold px-1 overflow-hidden hover:z-10 hover:scale-105 transition-all cursor-pointer group"
                                                                     style={{ left: `${((startH-8)/11)*100}%`, width: `${(dur/11)*100}%` }}>
                                                                    <div className="truncate">{b.title}</div>
                                                                    <button onClick={()=>handleDelete(b.id)} className="hidden group-hover:block absolute top-0 right-0 p-1 text-red-600 bg-white"><Icon name="trash-2" size={12}/></button>
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <ScheduleAnalytics bookings={bookings} />
                                </div>
                            )}

                            {activeTab === 'rooms' && (
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-in">
                                    {filteredRooms.map(r => (
                                        // UPDATED: DARK GREEN CARD HEADER
                                        <div key={r.id} className="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all overflow-hidden group">
                                            <div className="bg-hse-primary p-4 flex items-center justify-between">
                                                <h3 className="font-bold text-lg text-white">{r.name}</h3>
                                                <div className="text-emerald-100 bg-white/10 p-2 rounded-lg">
                                                     <Icon name={r.type === 'Room' ? "presentation" : "monitor"} size={20} />
                                                </div>
                                            </div>
                                            <div className="p-6 pt-4">
                                                <p className="text-sm text-slate-500 mb-4 font-medium">{r.type} • {r.capacity} Seats</p>
                                                <div className="text-xs text-slate-500 mb-6 flex flex-wrap gap-2">
                                                    {r.amenities.map(a => <span key={a} className="bg-slate-100 px-2 py-1 rounded">{a}</span>)}
                                                </div>
                                                <button onClick={() => { setNewBooking(p => ({...p, roomId: r.id})); setIsBookingModalOpen(true); }} className="w-full py-2 border-2 border-hse-primary text-hse-primary font-bold rounded hover:bg-hse-primary hover:text-white transition uppercase text-xs">Book Now</button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </main>
                    </div>

                    {/* Mobile Nav */}
                    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-2 flex justify-around items-center z-50 pb-safe">
                        <MobileNavLink active={activeTab==='dashboard'} onClick={()=>setActiveTab('dashboard')} icon="bar-chart-3" label="Dashboard" />
                        <MobileNavLink active={activeTab==='schedule'} onClick={()=>setActiveTab('schedule')} icon="calendar" label="Schedule" />
                        <MobileNavLink active={activeTab==='rooms'} onClick={()=>setActiveTab('rooms')} icon="map-pin" label="Directory" />
                    </div>

                    {/* Modal */}
                    <Modal isOpen={isBookingModalOpen} onClose={() => setIsBookingModalOpen(false)} title="New Booking">
                        <form onSubmit={handleCreate} className="space-y-4">
                            {conflict && <div className="bg-red-50 text-red-700 p-2 rounded text-xs font-bold">Conflict with "{conflict.title}"</div>}
                            <input required className="w-full p-2 border rounded" placeholder="Title" value={newBooking.title} onChange={e => setNewBooking({...newBooking, title: e.target.value})} />
                            <select className="w-full p-2 border rounded" value={newBooking.roomId} onChange={e => setNewBooking({...newBooking, roomId: e.target.value})}>
                                <option value="">Select Resource</option>
                                {INITIAL_ROOMS.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                            </select>
                            <input required className="w-full p-2 border rounded" placeholder="Organiser" value={newBooking.organiser} onChange={e => setNewBooking({...newBooking, organiser: e.target.value})} />
                            <div className="flex gap-2">
                                <input type="date" required className="w-full p-2 border rounded" value={newBooking.date} onChange={e => setNewBooking({...newBooking, date: e.target.value})} />
                                <input type="time" required className="w-full p-2 border rounded" value={newBooking.startTime} onChange={e => setNewBooking({...newBooking, startTime: e.target.value})} />
                            </div>
                            <select className="w-full p-2 border rounded" value={newBooking.duration} onChange={e => setNewBooking({...newBooking, duration: e.target.value})}>
                                <option value="30">30 Mins</option><option value="60">1 Hr</option><option value="90">1.5 Hrs</option><option value="120">2 Hrs</option><option value="240">Half Day</option><option value="480">Full Day</option>
                            </select>
                            <button type="submit" disabled={!!conflict} className="w-full py-3 bg-hse-primary text-white font-bold rounded">Confirm Booking</button>
                        </form>
                    </Modal>

                    {notification && <div className="fixed bottom-20 right-4 bg-hse-primary text-white px-4 py-2 rounded shadow-lg animate-in">{notification.message}</div>}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
