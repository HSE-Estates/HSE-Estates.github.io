<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSE Project Gantt Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- HSE Favicon -->
    <link rel="icon" href="https://assets.hse.ie/static/hse-frontend/assets/favicons/favicon.ico">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
        }
        
        /* Custom Scrollbar */
        .gantt-chart-container::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        .gantt-chart-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        .gantt-chart-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 6px;
            border: 2px solid #f1f5f9;
        }
        .gantt-chart-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Tooltips */
        .gantt-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(5px);
            pointer-events: none;
        }
        .gantt-bar-wrapper:hover .gantt-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Dragging */
        .gantt-bar-wrapper {
            cursor: grab;
            transition: box-shadow 0.2s;
        }
        .gantt-bar-wrapper.dragging {
            cursor: grabbing;
            z-index: 50;
            opacity: 0.9;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Critical Path Styles */
        .critical-path-highlight {
            box-shadow: 0 0 0 2px #ef4444, 0 4px 12px rgba(239, 68, 68, 0.4);
            z-index: 40;
        }
        .dependency-arrow {
            fill: none;
            stroke: #64748b; /* Darker stroke for visibility */
            stroke-width: 1.5;
            transition: stroke 0.3s, opacity 0.3s;
        }
        .dependency-arrow.critical {
            stroke: #ef4444;
            stroke-width: 2.5;
            stroke-dasharray: 4;
            animation: dash 1s linear infinite;
        }
        @keyframes dash {
            to { stroke-dashoffset: -8; }
        }

        /* Range Slider */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #059669;
            cursor: pointer;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* SVG Layer */
        #dependency-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .group-header {
            background: linear-gradient(to right, #f1f5f9, #ffffff);
            border-bottom: 2px solid #e2e8f0;
        }

        .sort-header:hover {
            color: #059669;
            cursor: pointer;
            background-color: #f0fdf4;
        }
        
        /* Grid Lines High Visibility */
        .grid-line {
            border-right: 1px solid #cbd5e1; /* Darker slate-300 equivalent */
        }
        .grid-line.weekend {
            background-color: #f1f5f9; /* Darker background for weekends */
        }

        /* Print Optimisations */
        @media print {
            .no-print { display: none !important; }
            body { 
                background: white; 
                padding: 0; 
                font-size: 10px;
                /* Allow body to expand horizontally */
                width: fit-content; 
                overflow-x: visible;
            }
            .max-w-7xl { 
                max-width: none !important; 
                width: fit-content !important;
                box-shadow: none !important; 
                border: none; 
                margin: 0; 
                padding: 0; 
            }
            .gantt-chart-container { 
                /* Crucial for horizontal printing */
                overflow: visible !important; 
                display: block !important;
                height: auto !important;
                width: max-content !important; /* Force container to be full width of content */
                min-width: 100%;
            }
            #gantt-chart {
                width: max-content !important;
            }
            header { background: #006858 !important; -webkit-print-color-adjust: exact; padding: 10px !important; width: 100%; }
            
            .gantt-bar-wrapper { -webkit-print-color-adjust: exact; print-color-adjust: exact; box-shadow: none !important; border: 1px solid #000; }
            
            /* Handle Page Breaks */
            .flex.hover\:bg-white { 
                page-break-inside: avoid; 
                break-inside: avoid;
            }
            .group-header { 
                page-break-after: avoid; 
                break-after: avoid;
            }
            .sticky.top-0 {
                position: static !important;
            }
            /* Hide scrollbars in print */
            ::-webkit-scrollbar { display: none; }
        }
    </style>
</head>
<body class="bg-slate-100 p-4 md:p-8 min-h-screen text-slate-800">

    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200 flex flex-col h-[calc(100vh-4rem)]">
        <!-- Main Header -->
        <header class="p-5 text-white flex flex-col md:flex-row justify-between items-start md:items-center gap-4 shrink-0" style="background-color: #006858;">
            <div class="flex items-center gap-4 min-w-0 flex-1">
                <div class="bg-white p-2 rounded-lg shadow-sm shrink-0">
                    <img src="https://www.esther.ie/wp-content/uploads/2022/05/HSE-Logo-Green-NEW-no-background.png" alt="HSE Logo" class="h-8 w-auto">
                </div>
                <div class="min-w-0 w-full">
                    <input type="text" id="project-title" value="Project Timeline" class="text-2xl font-bold bg-transparent border-none text-white w-full focus:outline-none focus:ring-1 focus:ring-white/30 rounded px-1 -ml-1 placeholder-white/50 truncate">
                    <p class="text-xs font-medium opacity-80 mt-1 uppercase tracking-wider">Strategic Planning Suite</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 no-print flex-wrap shrink-0">
                <!-- Toolbar -->
                <div class="flex bg-black/20 p-1 rounded-xl border border-white/10">
                    <select id="view-mode" class="bg-transparent text-xs font-semibold text-white border-none focus:ring-0 cursor-pointer py-1.5 px-2">
                        <option value="day" class="text-slate-800">Day View</option>
                        <option value="week" class="text-slate-800">Week View</option>
                        <option value="month" class="text-slate-800">Month View</option>
                        <option value="year" class="text-slate-800">Year View</option>
                    </select>
                </div>

                <button id="toggle-critical" class="flex items-center gap-2 px-3 py-2 bg-black/20 hover:bg-black/30 rounded-xl transition-all border border-white/10 text-xs font-semibold" title="Show Critical Path">
                    <span class="w-2 h-2 rounded-full bg-red-400"></span>
                    Critical Path
                </button>

                <div class="w-px h-6 bg-white/20 mx-1"></div>

                <label for="file-input" class="cursor-pointer p-2 bg-white/10 hover:bg-white/20 rounded-xl transition-all border border-white/10" title="Import Excel">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                </label>
                <input type="file" id="file-input" class="hidden" accept=".xlsx, .xls">
                
                <button id="download-btn" title="Export Excel" class="p-2 bg-white/10 hover:bg-white/20 rounded-xl transition-all border border-white/10">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                </button>
                
                <button id="download-html-btn" title="Download as Interactive HTML (Carbon Copy)" class="p-2 bg-white/10 hover:bg-white/20 rounded-xl transition-all border border-white/10">
                   <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                    </svg>
                </button>

                <button id="print-btn" title="Print Project" class="p-2 bg-white/10 hover:bg-white/20 rounded-xl transition-all border border-white/10" onclick="window.print()">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                </button>

                <button id="new-project-btn" title="Clear Project (Start Empty)" class="p-2 bg-red-500/80 hover:bg-red-600 rounded-xl transition-all border border-white/10 ml-1">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                    </svg>
                </button>

                <button id="add-task-btn" class="ml-2 flex items-center gap-2 px-4 py-2 bg-white text-[#006858] font-bold text-xs uppercase tracking-wide rounded-xl hover:bg-emerald-50 transition-all shadow-lg active:scale-95">
                    <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    New Task
                </button>
            </div>
        </header>

        <!-- Stats & Filter Bar -->
        <div class="grid grid-cols-1 md:grid-cols-12 border-b border-slate-200 bg-white shrink-0 no-print shadow-sm z-20">
            <!-- Stats -->
            <div class="md:col-span-8 grid grid-cols-4 divide-x divide-slate-100">
                <div class="p-3 text-center md:text-left">
                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Total</p>
                    <p id="stat-total" class="text-xl font-bold text-slate-700 leading-none mt-1">0</p>
                </div>
                <div class="p-3">
                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Progress</p>
                    <div class="flex items-center gap-2 mt-1">
                        <p id="stat-progress" class="text-xl font-bold text-slate-700 leading-none">0%</p>
                        <div class="flex-1 h-1.5 bg-slate-100 rounded-full overflow-hidden max-w-[60px]">
                            <div id="stat-progress-bar" class="h-full bg-[#006858] transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="p-3 text-center md:text-left">
                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Done</p>
                    <p id="stat-completed" class="text-xl font-bold text-emerald-600 leading-none mt-1">0</p>
                </div>
                <div class="p-3 text-center md:text-left">
                    <p class="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Pending</p>
                    <p id="stat-pending" class="text-xl font-bold text-amber-500 leading-none mt-1">0</p>
                </div>
            </div>

            <!-- Filter -->
            <div class="md:col-span-4 p-3 flex items-center border-t md:border-t-0 md:border-l border-slate-100 bg-slate-50/50">
                <div class="relative w-full">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">
                        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </span>
                    <input type="text" id="search-input" placeholder="Filter tasks..." class="w-full pl-9 pr-3 py-1.5 bg-white border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all outline-none">
                </div>
            </div>
        </div>

        <!-- Gantt Chart Container -->
        <div id="gantt-chart-container" class="gantt-chart-container overflow-auto flex-1 relative bg-slate-50">
            <div id="gantt-chart" class="relative min-w-full">
                <!-- Content injected by JS -->
            </div>
            <svg id="dependency-lines">
                 <defs>
                    <marker id="arrow-head" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#64748b"></path>
                    </marker>
                    <marker id="arrow-head-critical" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444"></path>
                    </marker>
                 </defs>
            </svg>
        </div>

        <footer class="p-3 bg-white border-t border-slate-200 flex flex-col sm:flex-row justify-between items-center text-[10px] text-slate-400 shrink-0 gap-2 no-print">
            <div class="flex items-center gap-2">
                 <span class="font-medium text-[#006858]">HSE Project Planner</span>
                 <span class="text-slate-300">|</span>
                 <span>Data Status: Active</span>
            </div>
            <p class="uppercase tracking-widest font-bold opacity-60">Created by Dave Maher &copy; 2026</p>
        </footer>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4 transition-all duration-300 no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden transform scale-100 transition-transform border border-slate-100">
            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                <h2 id="modal-title" class="text-lg font-bold text-slate-800">Task Details</h2>
                <button id="close-modal-x" class="text-slate-400 hover:text-red-500 transition-colors">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="task-form" class="p-6 space-y-5">
                <input type="hidden" id="task-id">
                
                <div class="grid grid-cols-2 gap-5">
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Task Name</label>
                        <input type="text" id="task-name" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:bg-white outline-none transition-all text-sm font-medium" placeholder="e.g. Phase 1 Design" required>
                    </div>
                    <div class="col-span-2 sm:col-span-1">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Group</label>
                        <input type="text" id="task-group" list="group-suggestions" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:bg-white outline-none transition-all text-sm" placeholder="General">
                        <datalist id="group-suggestions"></datalist>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Start Date</label>
                        <input type="date" id="task-start" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm text-slate-600" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">End Date</label>
                        <input type="date" id="task-end" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none text-sm text-slate-600" required>
                    </div>
                </div>

                <div class="grid grid-cols-12 gap-5 items-end">
                    <div class="col-span-4">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Colour</label>
                        <div class="flex items-center gap-2">
                            <input type="color" id="task-color" class="h-9 w-full p-1 bg-white border border-slate-200 rounded-lg cursor-pointer">
                        </div>
                    </div>
                    <div class="col-span-8">
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5 flex justify-between">
                            <span>Progress</span>
                            <span id="progress-val" class="text-[#006858]">0%</span>
                        </label>
                        <input type="range" id="task-progress" min="0" max="100" value="0" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-[#006858]">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1.5">Dependencies (Hold Ctrl/Cmd to select multiple)</label>
                    <select id="task-dependencies" multiple class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none h-24 text-xs font-mono"></select>
                </div>

                <div class="pt-2 flex items-center justify-between border-t border-slate-100 mt-4">
                    <button type="button" id="delete-task-btn" class="text-red-500 hover:text-red-700 text-xs font-bold uppercase transition-colors opacity-0 pointer-events-none">Delete</button>
                    <div class="flex gap-3">
                        <button type="button" id="cancel-btn" class="px-4 py-2 bg-slate-100 text-slate-600 text-sm font-semibold rounded-lg hover:bg-slate-200 transition-colors">Cancel</button>
                        <button type="submit" class="px-5 py-2 bg-[#006858] text-white text-sm font-bold rounded-lg hover:bg-emerald-700 shadow-md shadow-emerald-200 transition-all">Save Changes</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE & CONFIG ---
            const CONFIG = {
                scales: {
                    day: { px: 40, unit: 'day' },
                    week: { px: 50, unit: 'week' },
                    month: { px: 60, unit: 'month' },
                    year: { px: 100, unit: 'year' }
                }
            };
            
            const getListWidth = () => window.innerWidth < 768 ? 160 : 420;
            const cachedState = window.CACHED_STATE || {};

            const hospitalTemplate = [
                { id: 1, name: "Site Clearance & Excavation", group: "1. Site Preparation", start: "2026-03-01", end: "2026-04-15", progress: 100, color: "#8b5cf6", dependencies: [] },
                { id: 2, name: "Deep Foundation Piling", group: "1. Site Preparation", start: "2026-04-16", end: "2026-06-30", progress: 60, color: "#8b5cf6", dependencies: [1] },
                { id: 3, name: "Structural Steel Frame", group: "2. Structure", start: "2026-07-01", end: "2026-11-15", progress: 20, color: "#0ea5e9", dependencies: [2] },
                { id: 4, name: "Concrete Floor Slabs", group: "2. Structure", start: "2026-08-01", end: "2026-12-01", progress: 10, color: "#0ea5e9", dependencies: [3] },
                { id: 5, name: "Roofing & Weatherproofing", group: "3. Exterior", start: "2026-11-01", end: "2027-02-01", progress: 0, color: "#10b981", dependencies: [3] },
                { id: 6, name: "Window & Fa√ßade Install", group: "3. Exterior", start: "2027-01-15", end: "2027-04-01", progress: 0, color: "#10b981", dependencies: [5] },
                { id: 7, name: "HVAC & Ductwork", group: "4. MEP Systems", start: "2026-12-01", end: "2027-06-01", progress: 0, color: "#f59e0b", dependencies: [4] },
                { id: 8, name: "Medical Gas Plumbing", group: "4. MEP Systems", start: "2027-02-01", end: "2027-05-15", progress: 0, color: "#f59e0b", dependencies: [4] },
                { id: 9, name: "Electrical Wiring (ICU)", group: "4. MEP Systems", start: "2027-03-01", end: "2027-07-01", progress: 0, color: "#f59e0b", dependencies: [7] },
                { id: 10, name: "Internal Partitions", group: "5. Interior Fit-out", start: "2027-04-01", end: "2027-08-01", progress: 0, color: "#ec4899", dependencies: [7,8] },
                { id: 11, name: "Operating Theatre Install", group: "5. Interior Fit-out", start: "2027-07-01", end: "2027-10-01", progress: 0, color: "#ec4899", dependencies: [10] },
                { id: 12, name: "Final Commissioning", group: "6. Handover", start: "2027-10-01", end: "2027-12-01", progress: 0, color: "#64748b", dependencies: [9,11] }
            ];

            let state = {
                tasks: cachedState.tasks || JSON.parse(localStorage.getItem('gantt-pro-data')) || hospitalTemplate,
                viewMode: cachedState.viewMode || 'day',
                sortBy: cachedState.sortBy || 'group',
                showCriticalPath: false,
                filterTerm: '',
                dragTarget: null,
                dragStartX: 0,
                originalTask: null,
                minDate: null,
                maxDate: null,
                listWidth: getListWidth()
            };

            document.getElementById('view-mode').value = state.viewMode;

            const refs = {
                chart: document.getElementById('gantt-chart'),
                container: document.getElementById('gantt-chart-container'),
                svg: document.getElementById('dependency-lines'),
                modal: document.getElementById('task-modal'),
                form: document.getElementById('task-form')
            };

            const parseDate = (d) => new Date(d);
            const formatDate = (d) => d.toISOString().split('T')[0];
            const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
            const dayDiff = (s, e) => (parseDate(e) - parseDate(s)) / (1000 * 60 * 60 * 24);
            const getColWidth = () => CONFIG.scales[state.viewMode].px;

            const getX = (dateStr, minDate) => {
                const date = parseDate(dateStr);
                const min = parseDate(minDate);
                const cw = getColWidth();
                
                if (state.viewMode === 'day') {
                    const diff = Math.round((date - min) / (1000*60*60*24));
                    return diff * cw;
                } else if (state.viewMode === 'week') {
                    const diff = (date - min) / (1000*60*60*24*7);
                    return diff * cw;
                } else if (state.viewMode === 'month') {
                    // Approximate month diff for smoother drawing
                    const yearDiff = date.getFullYear() - min.getFullYear();
                    const monthDiff = date.getMonth() - min.getMonth();
                    const dayRatio = date.getDate() / new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();
                    return ((yearDiff * 12) + monthDiff + dayRatio - (min.getDate()/30)) * cw; 
                } else if (state.viewMode === 'year') {
                    const yearDiff = date.getFullYear() - min.getFullYear();
                    const dayRatio = (date - new Date(date.getFullYear(), 0, 1)) / (1000*60*60*24*365);
                    return (yearDiff + dayRatio) * cw;
                }
            };

            const getWidth = (start, end, minDate) => {
                const x1 = getX(start, minDate);
                const x2 = getX(end, minDate);
                // Ensure at least a sliver is visible
                return Math.max(x2 - x1, 4);
            };

            // Calculate start/end based on x position (Inverse of getX)
            const getDateFromX = (x, minDate) => {
                const cw = getColWidth();
                const min = parseDate(minDate);
                let result = new Date(min);

                if (state.viewMode === 'day') {
                    const days = Math.round(x / cw);
                    result.setDate(min.getDate() + days);
                } else if (state.viewMode === 'week') {
                    const days = Math.round((x / cw) * 7);
                    result.setDate(min.getDate() + days);
                } else if (state.viewMode === 'month') {
                    // Roughly map back
                    const totalMonths = x / cw;
                    result.setMonth(min.getMonth() + Math.floor(totalMonths));
                    const fraction = totalMonths % 1;
                    result.setDate(Math.floor(fraction * 30));
                } else if (state.viewMode === 'year') {
                    const totalYears = x / cw;
                    result.setFullYear(min.getFullYear() + Math.floor(totalYears));
                    const fraction = totalYears % 1;
                    result.setMonth(Math.floor(fraction * 12));
                }
                return formatDate(result);
            };

            const saveState = () => {
                localStorage.setItem('gantt-pro-data', JSON.stringify(state.tasks));
                updateStats();
            };

            const calculateCriticalPath = () => {
                state.tasks.forEach(t => t.isCritical = false);
                if (!state.showCriticalPath) return;
                let maxEnd = new Date(0);
                state.tasks.forEach(t => { const end = parseDate(t.end); if (end > maxEnd) maxEnd = end; });
                const isLinkedToEnd = (task) => {
                    const taskEnd = parseDate(task.end);
                    if (Math.abs(maxEnd - taskEnd) < 86400000) return true; 
                    const children = state.tasks.filter(c => c.dependencies && c.dependencies.includes(task.id));
                    return children.some(child => child.isCritical && parseDate(child.start) <= addDays(parseDate(task.end), 1));
                };
                const sorted = [...state.tasks].sort((a,b) => parseDate(b.end) - parseDate(a.end));
                sorted.forEach(t => { if (isLinkedToEnd(t)) t.isCritical = true; });
            };

            const cascadeDates = (rootId) => {
                const q = [rootId];
                const seen = new Set();
                while(q.length) {
                    const pid = q.shift();
                    if(seen.has(pid)) continue;
                    seen.add(pid);
                    const children = state.tasks.filter(t => t.dependencies && t.dependencies.includes(pid));
                    children.forEach(child => {
                        const parents = state.tasks.filter(t => child.dependencies.includes(t.id));
                        const maxParentEnd = parents.reduce((max, p) => {
                            const end = parseDate(p.end);
                            return end > max ? end : max;
                        }, new Date(0));
                        const nextStart = addDays(maxParentEnd, 1);
                        if (parseDate(child.start) < nextStart) {
                            const dur = dayDiff(child.start, child.end); // Raw days
                            child.start = formatDate(nextStart);
                            child.end = formatDate(addDays(nextStart, Math.round(dur)));
                            q.push(child.id);
                        }
                    });
                }
            };

            const updateStats = () => {
                const total = state.tasks.length;
                const completed = state.tasks.filter(t => t.progress === 100).length;
                const avg = total ? Math.round(state.tasks.reduce((a,t) => a + t.progress, 0) / total) : 0;
                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-completed').innerText = completed;
                document.getElementById('stat-pending').innerText = total - completed;
                document.getElementById('stat-progress').innerText = avg + '%';
                document.getElementById('stat-progress-bar').style.width = avg + '%';
            };

            window.toggleSort = (mode) => {
                if (state.sortBy === mode && mode !== 'group') state.sortBy = 'group';
                else state.sortBy = mode;
                render();
            };

            const getSortIcon = (mode) => state.sortBy === mode ? '‚ñº' : '';

            const render = () => {
                const filtered = state.tasks.filter(t => t.name.toLowerCase().includes(state.filterTerm.toLowerCase()));
                if (!filtered.length) {
                    refs.chart.innerHTML = `<div class="p-12 text-center text-slate-400 font-mono text-sm">No tasks found.</div>`;
                    refs.svg.innerHTML = '';
                    return;
                }

                calculateCriticalPath();

                const sorted = [...filtered].sort((a,b) => {
                    const gA = (a.group || 'General').toLowerCase();
                    const gB = (b.group || 'General').toLowerCase();
                    if (gA !== gB) return gA.localeCompare(gB);
                    if (state.sortBy === 'start') return parseDate(a.start) - parseDate(b.start);
                    if (state.sortBy === 'end') return parseDate(a.end) - parseDate(b.end);
                    if (state.sortBy === 'duration') return dayDiff(b.start, b.end) - dayDiff(a.start, a.end);
                    return parseDate(a.start) - parseDate(b.start);
                });

                // --- Calculate Timeline Bounds ---
                const allDates = state.tasks.flatMap(t => [parseDate(t.start), parseDate(t.end)]);
                let minT = new Date(Math.min(...allDates));
                let maxT = new Date(Math.max(...allDates));
                
                // Add padding based on view mode
                minT.setDate(minT.getDate() - 15);
                maxT.setDate(maxT.getDate() + 30);

                // Align Grid Start
                if (state.viewMode === 'week') {
                    const day = minT.getDay() || 7;
                    if(day !== 1) minT.setHours(-24 * (day - 1));
                } else if (state.viewMode === 'month') {
                    minT.setDate(1);
                } else if (state.viewMode === 'year') {
                    minT.setMonth(0, 1);
                }
                
                state.minDate = formatDate(minT);
                state.maxDate = formatDate(maxT);

                // Determine Grid Columns
                let gridCols = [];
                let curr = new Date(minT);
                const end = new Date(maxT);
                
                while(curr <= end) {
                    let label = '';
                    let subLabel = '';
                    let isWeekend = false;
                    let isMajor = false;

                    if (state.viewMode === 'day') {
                        label = curr.getDate();
                        subLabel = curr.toLocaleString('en-GB', {weekday:'narrow'});
                        isWeekend = curr.getDay() === 0 || curr.getDay() === 6;
                        if(curr.getDate() === 1) isMajor = true; // Start of month
                        curr.setDate(curr.getDate() + 1);
                    } else if (state.viewMode === 'week') {
                        label = `W${getWeekNumber(curr)}`;
                        if(curr.getDate() <= 7) isMajor = true; // Roughly start of month
                        curr.setDate(curr.getDate() + 7);
                    } else if (state.viewMode === 'month') {
                        label = curr.toLocaleString('en-GB', {month:'short'});
                        if(curr.getMonth() === 0) isMajor = true; // Start of year
                        curr.setMonth(curr.getMonth() + 1);
                    } else if (state.viewMode === 'year') {
                        label = curr.getFullYear();
                        curr.setFullYear(curr.getFullYear() + 1);
                    }
                    gridCols.push({ label, subLabel, isWeekend, isMajor });
                }

                const colW = getColWidth();
                const gridWidth = gridCols.length * colW;

                let html = '';
                
                // 1. Header
                html += `<div class="flex sticky top-0 z-30 bg-white border-b border-slate-200 shadow-sm print-header">
                    <div class="flex-none bg-slate-50 text-[11px] text-slate-500 uppercase flex items-center border-r border-slate-200" style="width: ${state.listWidth}px">
                        <div class="flex-1 px-4 font-bold cursor-pointer hover:text-emerald-600" onclick="toggleSort('group')">Task Name ${getSortIcon('group')}</div>
                        <div class="w-24 px-2 hidden md:block font-bold border-l border-slate-100 sort-header" onclick="toggleSort('start')">Start ${getSortIcon('start')}</div>
                        <div class="w-24 px-2 hidden md:block font-bold border-l border-slate-100 sort-header" onclick="toggleSort('end')">Finish ${getSortIcon('end')}</div>
                        <div class="w-14 text-center hidden md:block font-bold border-l border-slate-100 sort-header" onclick="toggleSort('duration')">Dur.</div>
                    </div>
                    <div class="flex relative" style="width: ${gridWidth}px">`;
                
                gridCols.forEach(col => {
                    const borderClass = col.isMajor ? 'border-l-2 border-slate-400' : 'border-r border-slate-100';
                    html += `<div class="flex-none flex flex-col justify-end pb-1 text-center ${borderClass} ${col.isWeekend ? 'bg-slate-50/50' : ''}" style="width: ${colW}px; height: 36px; overflow:hidden;">
                        <div class="text-[9px] text-slate-400 leading-none">${col.subLabel}</div>
                        <div class="text-[11px] font-bold text-slate-600">${col.label}</div>
                    </div>`;
                });
                html += `</div></div>`;

                // 2. Rows
                let currentGroup = null;
                sorted.forEach(t => {
                    if (t.group !== currentGroup) {
                        currentGroup = t.group || 'General';
                        html += `<div class="flex group-header sticky left-0 z-20">
                            <div class="flex-none px-4 py-1.5 text-[10px] font-bold uppercase text-slate-500 tracking-wider w-full">üìÇ ${currentGroup}</div>
                        </div>`;
                    }

                    // Calculate bar position using new unified getX
                    const leftPx = getX(t.start, state.minDate);
                    const widthPx = getWidth(t.start, t.end, state.minDate);
                    const duration = Math.round(dayDiff(t.start, t.end)) + 1;
                    const criticalClass = t.isCritical && state.showCriticalPath ? 'critical-path-highlight' : '';
                    
                    html += `<div class="flex hover:bg-white border-b border-slate-100 transition-colors h-10 relative">
                        <div class="flex-none flex items-center border-r border-slate-200 bg-white sticky left-0 z-20 group cursor-pointer" 
                             style="width: ${state.listWidth}px" onclick="app.editTask(${t.id})">
                            <div class="flex-1 px-4 text-xs font-semibold text-slate-700 truncate group-hover:text-emerald-700 transition-colors" title="${t.name}">${t.name}</div>
                            <div class="w-24 px-2 text-[10px] text-slate-500 border-l border-slate-100 hidden md:block truncate">${t.start}</div>
                            <div class="w-24 px-2 text-[10px] text-slate-500 border-l border-slate-100 hidden md:block truncate">${t.end}</div>
                            <div class="w-14 text-center text-[10px] font-mono text-slate-400 border-l border-slate-100 hidden md:block">${duration}d</div>
                        </div>

                        <div class="flex relative flex-1 h-full items-center" style="width: ${gridWidth}px">
                             <div class="absolute inset-0 flex pointer-events-none">`;
                             
                             gridCols.forEach(col => {
                                 const border = col.isMajor ? 'border-l border-slate-300' : 'border-r border-slate-50';
                                 html += `<div class="flex-none ${border} ${col.isWeekend ? 'bg-slate-50/30' : ''}" style="width: ${colW}px"></div>`;
                             });

                    html += `</div>
                            <div class="gantt-bar-wrapper absolute h-6 rounded shadow-sm flex items-center overflow-hidden ${criticalClass}"
                                 data-id="${t.id}"
                                 style="left: ${leftPx}px; width: ${widthPx}px; background-color: ${t.color}">
                                <div class="h-full bg-black/10 pointer-events-none" style="width: ${t.progress}%"></div>
                                ${widthPx > 60 ? `<span class="absolute px-2 text-[10px] font-bold text-white drop-shadow-md truncate w-full pointer-events-none">${t.progress}%</span>` : ''}
                                <div class="gantt-tooltip absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-800 text-white text-xs p-2 rounded shadow-xl whitespace-nowrap z-50">
                                    <div class="font-bold">${t.name}</div>
                                    <div class="opacity-75 text-[10px]">${t.start} ‚ûù ${t.end}</div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });

                refs.chart.innerHTML = html;
                refs.chart.style.width = `${state.listWidth + gridWidth}px`;
                
                setTimeout(() => drawDependencies(sorted), 0);
                setupDragEvents();
            };

            const drawDependencies = (renderedTasks) => {
                const svg = refs.svg;
                svg.innerHTML = '';
                svg.setAttribute('width', refs.chart.scrollWidth);
                svg.setAttribute('height', refs.chart.scrollHeight);

                const defs = `<defs>
                    <marker id="arrow-normal" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#64748b"></path></marker>
                    <marker id="arrow-critical" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#ef4444"></path></marker>
                </defs>`;
                svg.innerHTML = defs;

                renderedTasks.forEach(task => {
                    if (!task.dependencies || !task.dependencies.length) return;
                    const elChild = document.querySelector(`.gantt-bar-wrapper[data-id="${task.id}"]`);
                    if (!elChild) return;
                    task.dependencies.forEach(pid => {
                        const elParent = document.querySelector(`.gantt-bar-wrapper[data-id="${pid}"]`);
                        if (!elParent) return;
                        const chartRect = refs.chart.getBoundingClientRect();
                        const pRect = elParent.getBoundingClientRect();
                        const cRect = elChild.getBoundingClientRect();
                        const x1 = pRect.right - chartRect.left;
                        const y1 = pRect.top + (pRect.height / 2) - chartRect.top;
                        const x2 = cRect.left - chartRect.left;
                        const y2 = cRect.top + (cRect.height / 2) - chartRect.top;
                        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                        const isCrit = state.showCriticalPath && task.isCritical;
                        const midX = x1 + 10; 
                        const d = `M ${x1} ${y1} L ${midX} ${y1} L ${midX} ${y2} L ${x2} ${y2}`;
                        path.setAttribute('d', d);
                        path.setAttribute('class', `dependency-arrow ${isCrit ? 'critical' : ''}`);
                        path.setAttribute('marker-end', `url(#arrow-${isCrit ? 'critical' : 'normal'})`);
                        svg.appendChild(path);
                    });
                });
            };

            const setupDragEvents = () => {
                document.querySelectorAll('.gantt-bar-wrapper').forEach(el => {
                    el.onmousedown = (e) => {
                        if (e.button !== 0) return;
                        e.stopPropagation();
                        e.preventDefault();
                        const id = parseInt(el.dataset.id);
                        state.dragTarget = id;
                        state.dragStartX = e.clientX;
                        state.originalTask = {...state.tasks.find(t => t.id === id)};
                        state.initialLeft = parseFloat(el.style.left);
                        el.classList.add('dragging');
                        document.body.style.cursor = 'grabbing';
                        window.addEventListener('mousemove', handleDragMove);
                        window.addEventListener('mouseup', handleDragEnd);
                    };
                });
            };

            const handleDragMove = (e) => {
                if (!state.dragTarget) return;
                const el = document.querySelector(`.gantt-bar-wrapper[data-id="${state.dragTarget}"]`);
                if (!el) return;
                const dx = e.clientX - state.dragStartX;
                el.style.left = `${state.initialLeft + dx}px`;
            };

            const handleDragEnd = (e) => {
                window.removeEventListener('mousemove', handleDragMove);
                window.removeEventListener('mouseup', handleDragEnd);
                const id = state.dragTarget;
                const el = document.querySelector(`.gantt-bar-wrapper[data-id="${id}"]`);
                if (el) {
                    el.classList.remove('dragging');
                    document.body.style.cursor = 'default';
                    const dx = e.clientX - state.dragStartX;
                    
                    if (Math.abs(dx) > 5) {
                        const t = state.tasks.find(x => x.id === id);
                        const initialDateX = getX(state.originalTask.start, state.minDate);
                        const newX = initialDateX + dx;
                        
                        const newStartDateStr = getDateFromX(newX, state.minDate);
                        const durationDays = dayDiff(state.originalTask.start, state.originalTask.end);
                        
                        t.start = newStartDateStr;
                        t.end = formatDate(addDays(parseDate(newStartDateStr), Math.round(durationDays)));
                        
                        cascadeDates(t.id);
                        saveState();
                        render();
                    } else {
                        // Snap back if barely moved
                        el.style.left = `${state.initialLeft}px`;
                    }
                }
                state.dragTarget = null;
            };

            // Input handlers
            document.getElementById('add-task-btn').onclick = () => {
                refs.form.reset();
                document.getElementById('task-id').value = '';
                document.getElementById('task-color').value = '#006858';
                document.getElementById('delete-task-btn').classList.add('opacity-0', 'pointer-events-none');
                populateDeps([]);
                refs.modal.classList.remove('hidden');
                refs.modal.classList.add('flex');
            };

            document.getElementById('cancel-btn').onclick = () => {
                refs.modal.classList.add('hidden');
                refs.modal.classList.remove('flex');
            };
            document.getElementById('close-modal-x').onclick = document.getElementById('cancel-btn').onclick;

            document.getElementById('task-progress').oninput = (e) => {
                document.getElementById('progress-val').innerText = e.target.value + '%';
            };

            document.getElementById('view-mode').onchange = (e) => {
                state.viewMode = e.target.value;
                render();
            };

            document.getElementById('toggle-critical').onclick = (e) => {
                state.showCriticalPath = !state.showCriticalPath;
                e.currentTarget.classList.toggle('bg-black/50');
                render();
            };

            document.getElementById('search-input').oninput = (e) => {
                state.filterTerm = e.target.value;
                render();
            };
            
            window.onresize = () => {
                state.listWidth = getListWidth();
                render();
            };

            document.getElementById('new-project-btn').onclick = () => {
                if(confirm("Are you sure you want to delete this project? This cannot be undone.")) {
                    localStorage.removeItem('gantt-pro-data');
                    state.tasks = []; // Set to empty array, NOT template
                    state.sortBy = 'group';
                    state.viewMode = 'day';
                    saveState();
                    render();
                }
            };

            refs.form.onsubmit = (e) => {
                e.preventDefault();
                const idVal = document.getElementById('task-id').value;
                const deps = Array.from(document.getElementById('task-dependencies').selectedOptions).map(o => parseInt(o.value));

                const taskData = {
                    name: document.getElementById('task-name').value,
                    group: document.getElementById('task-group').value,
                    start: document.getElementById('task-start').value,
                    end: document.getElementById('task-end').value,
                    progress: parseInt(document.getElementById('task-progress').value),
                    color: document.getElementById('task-color').value,
                    dependencies: deps
                };

                if (idVal) {
                    const idx = state.tasks.findIndex(t => t.id == idVal);
                    state.tasks[idx] = { ...state.tasks[idx], ...taskData };
                    cascadeDates(parseInt(idVal));
                } else {
                    const newId = state.tasks.length ? Math.max(...state.tasks.map(t => t.id)) + 1 : 1;
                    state.tasks.push({ id: newId, ...taskData });
                }

                refs.modal.classList.add('hidden');
                refs.modal.classList.remove('flex');
                saveState();
                render();
            };

            document.getElementById('delete-task-btn').onclick = () => {
                const id = parseInt(document.getElementById('task-id').value);
                if(confirm('Delete this task?')) {
                    state.tasks = state.tasks.filter(t => t.id !== id);
                    state.tasks.forEach(t => {
                        if(t.dependencies) t.dependencies = t.dependencies.filter(d => d !== id);
                    });
                    refs.modal.classList.add('hidden');
                    refs.modal.classList.remove('flex');
                    saveState();
                    render();
                }
            };

            document.getElementById('file-input').onchange = (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const data = new Uint8Array(evt.target.result);
                    const wb = XLSX.read(data, {type:'array'});
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    if(json.length) {
                        state.tasks = json.map((row, i) => ({
                            id: row.ID || i+1,
                            name: row.Name || 'Task',
                            group: row.Group || 'General',
                            start: row.Start,
                            end: row.End,
                            progress: row.Progress || 0,
                            color: '#10b981',
                            dependencies: row.Dependencies ? String(row.Dependencies).split(',').map(Number) : []
                        }));
                        saveState();
                        render();
                    }
                };
                reader.readAsArrayBuffer(file);
            };

            document.getElementById('download-btn').onclick = () => {
                const ws = XLSX.utils.json_to_sheet(state.tasks.map(t => ({
                    ID: t.id,
                    Name: t.name,
                    Group: t.group,
                    Start: t.start,
                    End: t.end,
                    Progress: t.progress,
                    Dependencies: t.dependencies.join(',')
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Tasks");
                XLSX.writeFile(wb, "Project_Plan.xlsx");
            };

            document.getElementById('download-html-btn').onclick = () => {
                const timestamp = new Date().toISOString().split('T')[0];
                const fileName = `Project_Gantt_${timestamp}.html`;
                
                // Get current HTML
                let html = document.documentElement.outerHTML;
                
                // State to preserve (Tasks + View Mode + Sort)
                const saveState = {
                    tasks: state.tasks,
                    viewMode: state.viewMode,
                    sortBy: state.sortBy
                };

                // Remove any existing saved data script to avoid duplicates
                html = html.replace(/<script id="gantt-data-state">[\s\S]*?<\/script>/gi, '');
                
                // Inject new data script safely
                const closingScript = '<' + '/script>'; 
                const dataScript = `<script id="gantt-data-state">window.CACHED_STATE = ${JSON.stringify(saveState)};${closingScript}`;
                html = html.replace('</head>', `${dataScript}\n</head>`);
                
                const blob = new Blob([html], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            window.app = {
                editTask: (id) => {
                    const t = state.tasks.find(x => x.id === id);
                    if(!t) return;
                    document.getElementById('task-id').value = t.id;
                    document.getElementById('task-name').value = t.name;
                    document.getElementById('task-group').value = t.group;
                    document.getElementById('task-start').value = t.start;
                    document.getElementById('task-end').value = t.end;
                    document.getElementById('task-progress').value = t.progress;
                    document.getElementById('progress-val').innerText = t.progress + '%';
                    document.getElementById('task-color').value = t.color;
                    
                    populateDeps(t.dependencies, t.id);
                    document.getElementById('delete-task-btn').classList.remove('opacity-0', 'pointer-events-none');
                    refs.modal.classList.remove('hidden');
                    refs.modal.classList.add('flex');
                }
            };

            function populateDeps(selectedIds = [], currentId = null) {
                const sel = document.getElementById('task-dependencies');
                sel.innerHTML = '';
                state.tasks.forEach(t => {
                    if (t.id === currentId) return;
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.text = `${t.id}: ${t.name}`;
                    if (selectedIds && selectedIds.includes(t.id)) opt.selected = true;
                    sel.appendChild(opt);
                });
            }

            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            }

            updateStats();
            render();
            
            const groupList = document.getElementById('group-suggestions');
            const groups = [...new Set(state.tasks.map(t => t.group))];
            groups.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                groupList.appendChild(opt);
            });
        });
    </script>
</body>
</html>
